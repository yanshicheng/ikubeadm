# ikubeadm

![Kubernetes](https://img.shields.io/badge/Kubernetes-%E5%A4%9A%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2-326CE5?style=flat-square&logo=kubernetes&logoColor=white)![Ansible](https://img.shields.io/badge/Ansible-%E8%87%AA%E5%8A%A8%E5%8C%96-EE0000?style=flat-square&logo=ansible&logoColor=white)![Container](https://img.shields.io/badge/%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6-Docker%2FContainerd-2496ED?style=flat-square&logo=docker&logoColor=white)![Platform](https://img.shields.io/badge/å¹³å°-CentOS%20|%20Ubuntu%20|%20AlmaLinux%20|%20EulerOS-lightgrey?style=flat-square)![License](https://img.shields.io/badge/%E5%BC%80%E6%BA%90%E5%8D%8F%E8%AE%AE-Apache%202.0-blue?style=flat-square)

## é¡¹ç›®ç®€ä»‹

ikubeadm æ˜¯ä¸€ä¸ªä¼ä¸šçº§ Kubernetes å¤šé›†ç¾¤è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œç®¡ç†è§£å†³æ–¹æ¡ˆï¼ŒåŸºäº Ansible æ„å»ºã€‚æä¾›äº†å®Œæ•´çš„éƒ¨ç½²æµæ°´çº¿ï¼Œæ”¯æŒä»ç³»ç»Ÿåˆå§‹åŒ–åˆ°é›†ç¾¤ç»„ä»¶éƒ¨ç½²çš„å…¨æµç¨‹è‡ªåŠ¨åŒ–ï¼Œä½¿é›†ç¾¤ç®¡ç†å‘˜èƒ½å¤Ÿä»¥å¯é‡å¤ã€ä¸€è‡´çš„æ–¹å¼å¿«é€Ÿéƒ¨ç½²å’Œç®¡ç†å¤šä¸ª Kubernetes é›†ç¾¤ã€‚

æ— è®ºæ˜¯åœ¨æœ¬åœ°ç¯å¢ƒã€æ•°æ®ä¸­å¿ƒè¿˜æ˜¯ç¦»çº¿ç¯å¢ƒä¸­ï¼Œikubeadm éƒ½èƒ½æä¾›çµæ´»çš„éƒ¨ç½²é€‰é¡¹å’Œä¸°å¯Œçš„å®šåˆ¶èƒ½åŠ›ï¼Œæ»¡è¶³ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒå¯¹ Kubernetes çš„éƒ¨ç½²å’Œç®¡ç†éœ€æ±‚ã€‚

â­ å¼‚æ„æ”¯æŒï¼Œæ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿï¼Œarm or amd æ··åˆéƒ¨ç½²ã€‚

â­ æ¯ä¸ª role éƒ½ç®€å•å†™äº† README å¯ä»¥å…·ä½“ä¸‹çœ‹ `roles/role_name/README.md`

â­ å…·ä½“äº†è§£å¯ä»¥æŸ¥çœ‹: ` roles/role_name/default/main.yml`

> â­ "ä¸€æ¬¡é…ç½®ï¼Œéšå¤„éƒ¨ç½²ï¼Œå¤šé›†ç¾¤ç»Ÿä¸€ç®¡ç†"

### æ ¸å¿ƒç‰¹æ€§ä¸åŠŸèƒ½s

#### ç®¡ç†ç‰¹æ€§

- **å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šä»ç³»ç»Ÿåˆå§‹åŒ–åˆ°é›†ç¾¤è¿ç»´çš„å®Œæ•´è¦†ç›–
- **å¤šé›†ç¾¤ç®¡ç†**ï¼šæ”¯æŒåœ¨å•ä¸€æ§åˆ¶å¹³é¢ä¸‹ç®¡ç†å¤šä¸ªå¼‚æ„ Kubernetes é›†ç¾¤

#### éƒ¨ç½²é€‰é¡¹

- çµæ´»éƒ¨ç½²æ¨¡å¼

  - æ§åˆ¶å¹³é¢æ”¯æŒé™æ€ Pod æ¨¡å¼å’ŒäºŒè¿›åˆ¶æ¨¡å¼éƒ¨ç½²
- é›†ç¾¤ç»„ä»¶æ”¯æŒ YAML é™æ€æ–‡ä»¶éƒ¨ç½²å’Œ Helm éƒ¨ç½²

#### å®¹å™¨ä¸ç½‘ç»œ

- å®¹å™¨è¿è¡Œæ—¶æ”¯æŒ

  - å®Œæ•´æ”¯æŒ Docker å’Œ Containerdï¼ˆæ¨èä½¿ç”¨ Containerdï¼‰
- è‡ªåŠ¨é…ç½®è¿è¡Œæ—¶å‚æ•°å’Œä¼˜åŒ–
- ç½‘ç»œè§£å†³æ–¹æ¡ˆ

  - æ”¯æŒ Calico ç½‘ç»œæ’ä»¶
- æ”¯æŒ BGP/IPIP/VXLAN å¤šç§ç½‘ç»œæ¨¡å¼

#### é«˜å¯ç”¨ä¸å®‰å…¨

- é«˜å¯ç”¨æ¶æ„

  - å¤šæ§åˆ¶å¹³é¢èŠ‚ç‚¹è®¾è®¡
  - å†…ç½® kube-vip æä¾›æ§åˆ¶å¹³é¢é«˜å¯ç”¨
  - æ”¯æŒå¤–éƒ¨è‡ªå®šä¹‰ lb è´Ÿè½½å‡è¡¡å™¨
- ETCD é›†ç¾¤çµæ´»é…ç½®

  - æ”¯æŒäºŒè¿›åˆ¶éƒ¨ç½²å’Œé™æ€ Pod éƒ¨ç½²
- æ”¯æŒæ¥å…¥å¤–éƒ¨ ETCD é›†ç¾¤
- å®‰å…¨åŠ å›º

  - TLS è¯ä¹¦è‡ªåŠ¨åŒ–ç®¡ç†
- é›†ç¾¤ç»„ä»¶é—´å®‰å…¨é€šä¿¡

#### å¼‚æ„æ”¯æŒ

- æ“ä½œç³»ç»Ÿ
  - æ”¯æŒ Debian ç³»åˆ—
  - æ”¯æŒ RedHat [ 'CentOS', 'RedHat', 'Rocky', 'AlmaLinux', 'EulerOS' ]
- CPU æ¶æ„
  - æ”¯æŒ amd64
  - æ”¯æŒ arm64

### å…¶ä»–ç‰¹æ€§

- **ç¦»çº¿éƒ¨ç½²æ”¯æŒ**ï¼šå†…ç½®é•œåƒå’Œè½¯ä»¶åŒ…ä¸‹è½½è„šæœ¬ï¼Œæ”¯æŒå®Œå…¨ç¦»çº¿ç¯å¢ƒéƒ¨ç½²
- **ä¸°å¯Œçš„ç»„ä»¶é›†æˆ**ï¼šå¼€ç®±å³ç”¨çš„æ ¸å¿ƒç»„ä»¶å’Œé™„åŠ åŠŸèƒ½
- **åŠŸèƒ½çº§å¼€å…³æ§åˆ¶**ï¼šé€šè¿‡å˜é‡æ§åˆ¶å„ç»„ä»¶åŠŸèƒ½çš„å¼€å¯/å…³é—­

### æŠ€æœ¯æ¶æ„

ikubeadm åŸºäº Ansible è‡ªåŠ¨åŒ–å¹³å°æ„å»ºï¼Œé‡‡ç”¨æ¨¡å—åŒ–çš„ Roles è®¾è®¡ï¼Œä½¿éƒ¨ç½²æµç¨‹æ¸…æ™°å¯æ§ã€‚æ ¸å¿ƒæ¶æ„åŒ…æ‹¬ï¼š

- **é…ç½®ç®¡ç†**ï¼šé›†ä¸­å¼é…ç½®ï¼Œå¤šé›†ç¾¤å·®å¼‚åŒ–ç®¡ç†
- **éƒ¨ç½²æµæ°´çº¿**ï¼šä»ç³»ç»Ÿåˆå§‹åŒ–åˆ°ç»„ä»¶éƒ¨ç½²çš„å®Œæ•´å·¥ä½œæµ
- **è§’è‰²åˆ†ç¦»**ï¼šå°†å„ç»„ä»¶çš„å®‰è£…é…ç½®å°è£…ä¸ºç‹¬ç«‹è§’è‰²
- **è„šæœ¬æ”¯æŒ**ï¼šè¾…åŠ©è„šæœ¬ç®€åŒ–ç¯å¢ƒå‡†å¤‡å’Œèµ„æºç®¡ç†

## å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

- éƒ¨ç½²æœºå™¨éœ€è¦å®‰è£… Ansible (2.9+)
- ç›®æ ‡æœåŠ¡å™¨ä¸º Linux ç³»ç»Ÿ  [ 'Debian,'CentOS', 'RedHat', 'Rocky', 'AlmaLinux', 'EulerOS' ]
- å®¹å™¨è¿è¡Œæ—¶è¦æ±‚ï¼š
  - Docker 20.10+ æˆ–
  - Containerd 1.6+ï¼ˆæ¨èï¼‰
- ç¡¬ä»¶æœ€ä½è¦æ±‚ï¼š
  - æ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼š2 CPUï¼Œ4GB å†…å­˜ï¼Œ50GB å­˜å‚¨
  - å·¥ä½œèŠ‚ç‚¹ï¼š2 CPUï¼Œ2GB å†…å­˜ï¼Œ50GB å­˜å‚¨

### ä»£ç å…‹éš†

```bash
cd /opt/
git clone https://github.com/yanshicheng/ikubeadm.git
```

> âš ï¸ **æ³¨æ„**ï¼šå¦‚æœä¸åœ¨ opt ç›®å½•ä¸‹ï¼Œè¯·æ‰‹åŠ¨ä¿®æ”¹ ansible.cfg æ–‡ä»¶ roles_path å­—æ®µæŒ‡å®šé¡¹ç›® roles è·¯å¾„ã€‚

### éƒ¨ç½²åŒ…å‡†å¤‡

#### é•œåƒé¢„ä¸‹è½½

```bash
# ä½¿ç”¨ Bash v4 è„šæœ¬ä¸‹è½½é•œåƒ
bash script/download-images-local-4.sh

# ä½¿ç”¨ Bash v3 è„šæœ¬ä¸‹è½½é•œåƒ(é€‚ç”¨äº macOS)
bash script/download-images-local-3.sh
```

> âš ï¸ **é•œåƒå¤„ç†è¯´æ˜**ï¼šä¸‹è½½å®Œé•œåƒåï¼Œæ‚¨æœ‰ä¸¤ç§é€‰æ‹©ï¼š
>
> 1. æ‰“åŒ… `registry data` ç›®å½•ååœ¨å†…ç½‘æœºå™¨ä¸Šéƒ¨ç½² registry ä»“åº“
> 2. å°†é•œåƒä¸Šä¼ åˆ°æ‚¨è‡ªå·±çš„ harbor ä»“åº“
>
> é…ç½®æ—¶éœ€ä¿®æ”¹ `deploy/deploy_name/config.yaml` ä¸­çš„ `registry` å’Œ `registry_ip` å‚æ•°ã€‚è¯·æ³¨æ„ä¿æŒæ­£ç¡®çš„äºŒçº§ç›®å½•ç»“æ„ã€‚

#### è½¯ä»¶åŒ…é¢„ä¸‹è½½

```bash
# ä¸‹è½½æ‰€éœ€çš„è½¯ä»¶åŒ…
bash script/download-packages-local.sh
```

> ğŸ“¦ **è½¯ä»¶åŒ…å¤„ç†è¯´æ˜**ï¼šå¦‚æœä¸æ˜¯åœ¨ Ansible æ§åˆ¶ä¸»æœºä¸Šä¸‹è½½ï¼Œåªéœ€å°†ä¸‹è½½å®Œæˆçš„è½¯ä»¶åŒ…æ”¾å…¥é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `packages` ç›®å½•å³å¯ã€‚

#### æœ¬åœ°æºé…ç½®

```bash
# é…ç½®æœ¬åœ° YUM å’Œ Docker æº
bash script/deploy_local_repo.sh
```

> âš ï¸ **æ³¨æ„**ï¼šæœ¬åœ°æºé…ç½®åŠŸèƒ½ç›®å‰è¿˜æœªå®Œå–„ï¼Œè¯·æ ¹æ®éœ€æ±‚è‡ªè¡Œæ­å»º yum æˆ– apt æºã€‚

### é›†ç¾¤éƒ¨ç½²æµç¨‹

#### 1. åˆ›å»ºæ–°çš„é›†ç¾¤éƒ¨ç½²

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ
â¯ bash script/add-deploy-cluster.sh -n mycluster
æ­£åœ¨åˆ›å»ºæ–°éƒ¨ç½² 'mycluster'...
æ­£åœ¨æ›´æ–°é…ç½®æ–‡ä»¶...

éƒ¨ç½² 'mycluster' å·²æˆåŠŸåˆ›å»ºï¼

åç»­æ­¥éª¤:
1. ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶: deploy/mycluster/config.yml
2. é…ç½®ä¸»æœºç›¸å…³ä¿¡æ¯: deploy/mycluster/hosts

å‡†å¤‡å¥½åï¼Œè¯·ä»ä¸»ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¼€å§‹éƒ¨ç½²:
ansible-playbook -e @deploy/mycluster/config.yml -i deploy/mycluster/hosts playbooks/00.deploy-kubernetes.yml
```

#### 2. é…ç½®é›†ç¾¤

1. ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶ï¼š`deploy/mycluster/config.yml`
2. é…ç½®ä¸»æœºä¿¡æ¯ï¼š`deploy/mycluster/hosts`

#### 3. æ‰§è¡Œéƒ¨ç½²

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œå®Œæ•´éƒ¨ç½²
ansible-playbook -e @deploy/mycluster/config.yml -i deploy/mycluster/hosts playbooks/00.deploy-kubernetes.yml

# æˆ–åˆ†æ­¥æ‰§è¡Œ
ansible-playbook -e @deploy/mycluster/config.yml -i deploy/mycluster/hosts playbooks/01.system-init.yml
ansible-playbook -e @deploy/mycluster/config.yml -i deploy/mycluster/hosts playbooks/02.chrony.yml
# ... å…¶ä»–æ­¥éª¤
```

## é¡¹ç›®æ˜ç»†

### ç›®å½•ç»“æ„

```
ikube-admin/
â”œâ”€â”€ ansible.cfg                        # Ansible é…ç½®æ–‡ä»¶
â”œâ”€â”€ deploy                             # éƒ¨ç½²é…ç½®ç›®å½•
â”‚   â””â”€â”€ example                        # ç¤ºä¾‹éƒ¨ç½²é…ç½®
â”‚       â”œâ”€â”€ config.yml                 # é›†ç¾¤é…ç½®æ–‡ä»¶
â”‚       â”œâ”€â”€ hosts                      # ä¸»æœºæ¸…å•æ–‡ä»¶
â”‚       â””â”€â”€ registry                   # é•œåƒä»“åº“è¯ä¹¦ç›®å½•
â”‚           â”œâ”€â”€ harbor.ikubeops.local
â”‚           â”‚   â””â”€â”€ ca.crt
â”‚           â””â”€â”€ registry1.example.com:5000
â”‚               â””â”€â”€ ca.crt
â”œâ”€â”€ images                             # å†…ç½®é•œåƒç›®å½•
â”œâ”€â”€ logs                               # éƒ¨ç½²æ—¥å¿—ç›®å½•
â”œâ”€â”€ packages                           # äºŒè¿›åˆ¶è½¯ä»¶åŒ…ç›®å½•
â”œâ”€â”€ playbooks                          # Ansible playbook ç›®å½•
â”‚   â”œâ”€â”€ 00.deploy-kubernetes.yml       # å®Œæ•´éƒ¨ç½²æµç¨‹
â”‚   â”œâ”€â”€ 01.system-init.yml             # ç³»ç»Ÿåˆå§‹åŒ–
â”‚   â”œâ”€â”€ 02.chrony.yml                  # æ—¶é—´åŒæ­¥æœåŠ¡
â”‚   â”œâ”€â”€ 03.container-runtime.yml       # å®¹å™¨è¿è¡Œæ—¶
â”‚   â”œâ”€â”€ 04.cert-manager.yml            # è¯ä¹¦ç®¡ç†
â”‚   â”œâ”€â”€ 05.kube-node.yml               # èŠ‚ç‚¹åˆå§‹åŒ–
â”‚   â”œâ”€â”€ 06.etcd.yml                    # ETCD é›†ç¾¤
â”‚   â”œâ”€â”€ 07.kube-vip.yaml               # æ§åˆ¶å¹³é¢é«˜å¯ç”¨
â”‚   â”œâ”€â”€ 08.kube-master.yml             # æ§åˆ¶å¹³é¢ç»„ä»¶
â”‚   â”œâ”€â”€ 09.kube-dns.yaml               # DNS æœåŠ¡
â”‚   â”œâ”€â”€ 10.kube-cni.yml                # ç½‘ç»œæ’ä»¶
â”‚   â”œâ”€â”€ 11.kube-addon.yaml             # é™„åŠ ç»„ä»¶
â”‚   â””â”€â”€ 90.restart-system.yml          # ç³»ç»Ÿé‡å¯
â”œâ”€â”€ roles                              # Ansible è§’è‰²ç›®å½•
â””â”€â”€ script                             # è¾…åŠ©è„šæœ¬ç›®å½•
```

### åŠŸèƒ½æ¸…å•


| åŠŸèƒ½æ¨¡å—   | æè¿°                         | çŠ¶æ€ |
| ---------- | ---------------------------- | ---- |
| ç³»ç»Ÿåˆå§‹åŒ– | ç³»ç»Ÿå‚æ•°ä¼˜åŒ–ã€ä¾èµ–å®‰è£…       | âœ…   |
| æ—¶é—´åŒæ­¥   | Chrony æœåŠ¡éƒ¨ç½²ä¸é…ç½®        | âœ…   |
| å®¹å™¨è¿è¡Œæ—¶ | Docker/Containerd å®‰è£…ä¸é…ç½® | âœ…   |
| è¯ä¹¦ç®¡ç†   | TLS è¯ä¹¦ç”Ÿæˆä¸åˆ†å‘           | âœ…   |
| èŠ‚ç‚¹åˆå§‹åŒ– | Kubelet æœåŠ¡é…ç½®ä¸å¯åŠ¨       | âœ…   |
| ETCD é›†ç¾¤  | é«˜å¯ç”¨æ•°æ®å­˜å‚¨é›†ç¾¤           | âœ…   |
| é«˜å¯ç”¨é…ç½® | Kube-VIP è™šæ‹Ÿ IP ç®¡ç†        | âœ…   |
| æ§åˆ¶å¹³é¢   | API æœåŠ¡å™¨ã€æ§åˆ¶å™¨ã€è°ƒåº¦å™¨   | âœ…   |
| DNS æœåŠ¡   | CoreDNS æœåŠ¡éƒ¨ç½²             | âœ…   |
| ç½‘ç»œæ’ä»¶   | Calico CNI éƒ¨ç½²              | âœ…   |
| å­˜å‚¨æœåŠ¡   | NFS å­˜å‚¨æä¾›ç¨‹åº             | âœ…   |
| è´Ÿè½½å‡è¡¡   | MetalLB å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨       | âœ…   |
| å…¥å£æ§åˆ¶å™¨ | Nginx Ingress Controller     | âœ…   |
| ç›‘æ§æœåŠ¡   | Metrics Server               | âœ…   |

### æ ¸å¿ƒç»„ä»¶

#### åŸºç¡€è®¾æ–½ç»„ä»¶

- **ç³»ç»Ÿåˆå§‹åŒ–**ï¼šç³»ç»Ÿå‚æ•°ä¼˜åŒ–ã€ç½‘ç»œé…ç½®ã€å®‰å…¨è®¾ç½®ã€å¿…è¦è½¯ä»¶åŒ…å®‰è£…
- **æ—¶é—´åŒæ­¥**ï¼šChrony æœåŠ¡éƒ¨ç½²ä¸é…ç½®
- **å®¹å™¨è¿è¡Œæ—¶**ï¼šDocker/Containerd å®‰è£…å’Œé…ç½®ã€é•œåƒä»“åº“é…ç½®ã€å®‰å…¨å’Œæ€§èƒ½ä¼˜åŒ–

#### Kubernetes æ ¸å¿ƒç»„ä»¶

- **è¯ä¹¦ç®¡ç†**ï¼šCA è¯ä¹¦ç”Ÿæˆã€ç»„ä»¶è¯ä¹¦åˆ†å‘ã€è¯ä¹¦æ›´æ–°å’Œè½®æ¢
- **ETCD é›†ç¾¤**ï¼šé«˜å¯ç”¨ ETCD éƒ¨ç½²ã€æ•°æ®ä¸€è‡´æ€§ä¿éšœã€å¤‡ä»½å’Œæ¢å¤æœºåˆ¶
- **Kubernetes æ§åˆ¶å¹³é¢**ï¼šAPI æœåŠ¡å™¨ã€æ§åˆ¶å™¨ç®¡ç†å™¨ã€è°ƒåº¦å™¨
- **èŠ‚ç‚¹ç»„ä»¶**ï¼šKubeletã€Kube-proxy é…ç½®ä¸ç®¡ç†

#### ç½‘ç»œä¸æ’ä»¶ç»„ä»¶

- **ç½‘ç»œç»„ä»¶**ï¼šCalico CNI æ’ä»¶ã€BGP/VXLAN/IPIP ç½‘ç»œæ¨¡å¼ã€ç½‘ç»œç­–ç•¥ç®¡ç†
- **DNS æœåŠ¡**ï¼šCoreDNS éƒ¨ç½²ä¸é…ç½®
- **é™„åŠ ç»„ä»¶**ï¼šMetalLB è´Ÿè½½å‡è¡¡å™¨ã€NFS å­˜å‚¨æä¾›ç¨‹åºã€Metrics Serverã€Nginx Ingress Controller

## é…ç½®æŒ‡å—

### åŸºç¡€é…ç½®


| å‚æ•°                     | è¯´æ˜             | é»˜è®¤å€¼                |
| ------------------------ | ---------------- | --------------------- |
| `deploy_name`            | éƒ¨ç½²åç§°         | `example`             |
| `base_dir`               | äºŒè¿›åˆ¶å®‰è£…è·¯å¾„   | `/opt/kube`           |
| `kube_base_dir`          | k8s è¯ä¹¦å­˜å‚¨è·¯å¾„ | `/etc/kubernetes`     |
| `kubelet_base_dir`       | kubelet æ•°æ®ç›®å½• | `/var/lib/kubelet`    |
| `container_data_root`    | å®¹å™¨æ•°æ®è·¯å¾„     | `/var/lib/containerd` |
| `kubernetes_version`     | Kubernetes ç‰ˆæœ¬  | `v1.32.3`             |
| `control_deploy_pattern` | æ§åˆ¶å¹³é¢éƒ¨ç½²æ¨¡å¼ | `manifest`            |
| `addon_deploy_pattern`   | æ’ä»¶éƒ¨ç½²æ¨¡å¼     | `yaml`                |
| `container_runtime`      | å®¹å™¨è¿è¡Œæ—¶       | `containerd`          |
| `container_version`      | å®¹å™¨è¿è¡Œæ—¶ç‰ˆæœ¬   | `2.0.4`               |

### ç½‘ç»œé…ç½®


| å‚æ•°                     | è¯´æ˜                   | é»˜è®¤å€¼          |
| ------------------------ | ---------------------- | --------------- |
| `kube_apiserver_lb_addr` | API æœåŠ¡å™¨è´Ÿè½½å‡è¡¡åœ°å€ | `172.16.1.200`  |
| `kube_apiserver_lb_port` | API æœåŠ¡å™¨ç«¯å£         | `6443`          |
| `service_cidr`           | æœåŠ¡ç½‘ç»œ CIDR          | `10.96.0.0/12`  |
| `pod_cidr`               | Pod ç½‘ç»œ CIDR          | `10.244.0.0/16` |
| `max_pods`               | èŠ‚ç‚¹æœ€å¤§ Pod æ•°é‡      | `110`           |
| `service_nodeport_range` | Service NodePort èŒƒå›´  | `30000-32767`   |
| `cluster_dns_domain`     | é›†ç¾¤ DNS åŸŸå          | `cluster.local` |

### è¯ä¹¦é…ç½®


| å‚æ•°               | è¯´æ˜             | é»˜è®¤å€¼ |
| ------------------ | ---------------- | ------ |
| `cert_update_mode` | è¯ä¹¦æ›´æ–°æ¨¡å¼     | `none` |
| `ca_expiry`        | CA è¯ä¹¦æœ‰æ•ˆæœŸ    | `20h`  |
| `cert_expiry`      | ç»„ä»¶è¯ä¹¦æœ‰æ•ˆæœŸ   | `20h`  |
| `custom_expiry`    | è‡ªå®šä¹‰è¯ä¹¦æœ‰æ•ˆæœŸ | `20h`  |

### ç»„ä»¶é…ç½®


| å‚æ•°                         | è¯´æ˜                    | é»˜è®¤å€¼           |
| ---------------------------- | ----------------------- | ---------------- |
| `cluster_cni`                | ç½‘ç»œæ’ä»¶                | `calico`         |
| `cluster_cni_namespace`      | ç½‘ç»œæ’ä»¶å‘½åç©ºé—´        | `calico-system`  |
| `calico_mode`                | Calico ç½‘ç»œæ¨¡å¼         | `vxlan`          |
| `use_external_etcd`          | æ˜¯å¦ä½¿ç”¨å¤–éƒ¨ ETCD       | `false`          |
| `etcd_deploy_mode`           | ETCD éƒ¨ç½²æ¨¡å¼           | `manifest`       |
| `etcd_data_dir`              | ETCD æ•°æ®ç›®å½•           | `/var/lib/etcd`  |
| `metrics_server_enabled`     | æ˜¯å¦éƒ¨ç½² Metrics Server | `true`           |
| `metallb_enabled`            | æ˜¯å¦éƒ¨ç½² MetalLB        | `true`           |
| `metallb_namespace`          | MetalLB å‘½åç©ºé—´        | `metallb-system` |
| `nfs_enabled`                | æ˜¯å¦éƒ¨ç½² NFS å­˜å‚¨       | `true`           |
| `nfs_namespace`              | NFS å‘½åç©ºé—´            | `nfs-system`     |
| `nginx_ingress_enabled`      | æ˜¯å¦éƒ¨ç½² Ingress-Nginx  | `true`           |
| `nginx_ingress_namespace`    | Ingress-Nginx å‘½åç©ºé—´  | `ingress-nginx`  |
| `nginx_ingress_service_type` | Ingress-Nginx æœåŠ¡ç±»å‹  | `ClusterIP`      |

## é«˜çº§åŠŸèƒ½

### è¯ä¹¦æ›´æ–°

```yaml
# è¯ä¹¦æ›´æ–°æ¨¡å¼
# none: ä¸æ›´æ–°ä»»ä½•è¯ä¹¦ï¼ˆé»˜è®¤å€¼ï¼‰
# ca_only: åªæ›´æ–° CA è¯ä¹¦ï¼Œä¸æ›´æ–°ç»„ä»¶è¯ä¹¦
# components_only: åªæ›´æ–°ç»„ä»¶è¯ä¹¦ï¼Œä¸æ›´æ–° CA è¯ä¹¦
# all: æ›´æ–°æ‰€æœ‰è¯ä¹¦
cert_update_mode: "none"

# è¯ä¹¦æœ‰æ•ˆæœŸè®¾ç½®
ca_expiry: "20h"      # CA è¯ä¹¦æœ‰æ•ˆæœŸ
cert_expiry: "20h"    # ç»„ä»¶è¯ä¹¦æœ‰æ•ˆæœŸ
```

### é«˜å¯ç”¨æ§åˆ¶å¹³é¢

```yaml
# Kube-VIP é…ç½®
kube_vip_deploy_mode: arp       # éƒ¨ç½²æ¨¡å¼ arp | bgp
kube_vip_interface: "eth2"      # ç½‘ç»œæ¥å£
kube_vip_version: "v0.8.9"      # Kube-VIP ç‰ˆæœ¬
```

### å¤–éƒ¨ ETCD é›†ç¾¤

```yaml
# ä½¿ç”¨å¤–éƒ¨ ETCD é›†ç¾¤
use_external_etcd: true
external_etcd_endpoints: "https://etcd-1.example.com:2379,https://etcd-2.example.com:2379,https://etcd-3.example.com:2379"
```

## æœ€ä½³å®è·µ

1. ç‰ˆæœ¬é€‰æ‹©
   - ä½¿ç”¨ç¨³å®šç‰ˆ Kubernetes
   - é¿å…ä½¿ç”¨é¢„è§ˆç‰ˆåŠŸèƒ½
2. å®¹å™¨è¿è¡Œæ—¶
   - ä¼˜å…ˆä½¿ç”¨ Containerd
   - ä¸ºå®¹å™¨æ•°æ®é…ç½®å•ç‹¬å­˜å‚¨
3. é«˜å¯ç”¨é…ç½®
   - è‡³å°‘éƒ¨ç½² 3 ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹
   - ä½¿ç”¨å¥‡æ•°ä¸ª ETCD èŠ‚ç‚¹
4. ç½‘ç»œè§„åˆ’
   - åˆç†è§„åˆ’ Pod å’Œ Service CIDR
   - é¿å…ä¸ç°æœ‰ç½‘ç»œé‡å 
5. èµ„æºé…ç½®
   - ä¸ºæ§åˆ¶å¹³é¢èŠ‚ç‚¹åˆ†é…è¶³å¤Ÿèµ„æº
   - æ ¹æ®å·¥ä½œè´Ÿè½½è°ƒæ•´ max_pods å€¼

## å¾…æ›´æ–°äº‹é¡¹

- [ ]  å¢åŠ æ›´å¤š CNI æ’ä»¶é€‰é¡¹ï¼ˆCiliumã€Flannelï¼‰
- [ ]  é›†æˆ Kubernetes å‡çº§åŠŸèƒ½
- [ ]  å¢åŠ é›†ç¾¤å¤‡ä»½å’Œæ¢å¤å·¥å…·
- [ ]  helm ç®¡ç†
- [ ]  é›†æˆæ›´å¤šç›‘æ§å’Œæ—¥å¿—è§£å†³æ–¹æ¡ˆ
- [ ]  æ‰€æœ‰åˆå§‹åŒ–é¡¹ç›® golang ç¼–å†™ ikubeadm-cli å·¥å…·
- [ ]  æ ¸å¿ƒç»„ä»¶äºŒè¿›åˆ¶éƒ¨ç½²
