# ETCD è§’è‰²

![ETCD](https://img.shields.io/badge/ETCD-%E6%95%B0%E6%8D%AE%E5%BA%93-blue)![Kubernetes](https://img.shields.io/badge/Kubernetes-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6-orange)![é«˜å¯ç”¨](https://img.shields.io/badge/%E9%AB%98%E5%8F%AF%E7%94%A8-%E9%9B%86%E7%BE%A4-green)

## ğŸ“‹ ç®€ä»‹

`etcd` è§’è‰²è´Ÿè´£éƒ¨ç½²å’Œç®¡ç† Kubernetes é›†ç¾¤çš„æ ¸å¿ƒç»„ä»¶ - etcd åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨æ•°æ®åº“ã€‚etcd æ˜¯ Kubernetes çš„"å¤§è„‘"ï¼Œç”¨äºå­˜å‚¨é›†ç¾¤çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯å’Œé…ç½®æ•°æ®ã€‚è¯¥è§’è‰²å®ç°äº† etcd é›†ç¾¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€è¯ä¹¦ç®¡ç†ä»¥åŠé›†ç¾¤çŠ¶æ€éªŒè¯ï¼Œç¡®ä¿éƒ¨ç½²çš„ etcd é›†ç¾¤é«˜å¯ç”¨ã€å®‰å…¨ä¸”å¯é ã€‚

æœ¬è§’è‰²æ”¯æŒä»¥é™æ€ Podï¼ˆmanifestï¼‰æ–¹å¼éƒ¨ç½² etcdï¼Œä½¿å…¶ä½œä¸º Kubernetes æ§åˆ¶å¹³é¢çš„ä¸€éƒ¨åˆ†è¿è¡Œï¼ŒåŒæ—¶ä¿æŒä¸ Kubernetes ç»„ä»¶çš„å®Œæ•´é›†æˆã€‚

## ğŸ¯ é€‚ç”¨åœºæ™¯

* **æ–°å»º Kubernetes é›†ç¾¤**ï¼šåˆå§‹éƒ¨ç½² Kubernetes é›†ç¾¤æ—¶çš„ etcd ç»„ä»¶å®‰è£…
* **é«˜å¯ç”¨é›†ç¾¤æ„å»º**ï¼šéœ€è¦æ„å»ºå¤šèŠ‚ç‚¹ etcd é›†ç¾¤ä»¥æä¾›é«˜å¯ç”¨æ€§
* **é›†ç¾¤æ‰©å±•**ï¼šå‘ç°æœ‰ etcd é›†ç¾¤æ·»åŠ æ–°æˆå‘˜
* **è¯ä¹¦æ›´æ–°**ï¼šéœ€è¦ä¸º etcd é›†ç¾¤æ›´æ–° TLS è¯ä¹¦
* **ç‰ˆæœ¬å‡çº§**ï¼šå‡çº§ etcd é›†ç¾¤åˆ°æ–°ç‰ˆæœ¬
* **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**ï¼šéœ€è¦å®‰å…¨ã€å¯é çš„æ•°æ®å­˜å‚¨åŸºç¡€è®¾æ–½
* **ç¦»çº¿ç¯å¢ƒéƒ¨ç½²**ï¼šæ”¯æŒåœ¨æ— äº’è”ç½‘è¿æ¥çš„ç¯å¢ƒä¸­éƒ¨ç½²

## âœ¨ åŠŸèƒ½è¯´æ˜

### ğŸ” å®‰å…¨ä¸è¯ä¹¦ç®¡ç†

* **TLS è¯ä¹¦ç”Ÿæˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆ etcd æ‰€éœ€çš„ TLS è¯ä¹¦å’Œå¯†é’¥
* **è¯ä¹¦åˆ†å‘**ï¼šå°†è¯ä¹¦å®‰å…¨åœ°åˆ†å‘åˆ°æ‰€æœ‰ etcd èŠ‚ç‚¹
* **åŸºäº CA çš„è®¤è¯**ï¼šä½¿ç”¨é›†ç¾¤ CA ç­¾å‘çš„è¯ä¹¦ç¡®ä¿é€šä¿¡å®‰å…¨

### ğŸ—ï¸ éƒ¨ç½²ä¸é…ç½®

* **é™æ€ Pod éƒ¨ç½²**ï¼šä»¥ Kubernetes é™æ€ Pod æ–¹å¼éƒ¨ç½² etcdï¼ˆmanifest æ¨¡å¼ï¼‰
* **é›†ç¾¤é…ç½®ç”Ÿæˆ**ï¼šæ ¹æ®èŠ‚ç‚¹ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆ etcd åˆå§‹é›†ç¾¤é…ç½®
* **æ•°æ®ç›®å½•ç®¡ç†**ï¼šåˆ›å»ºå¹¶é…ç½® etcd æ•°æ®å­˜å‚¨ç›®å½•

### ğŸ”„ é›†ç¾¤ç®¡ç†

* **é›†ç¾¤çŠ¶æ€éªŒè¯**ï¼šéƒ¨ç½²åè‡ªåŠ¨æ£€æŸ¥ etcd é›†ç¾¤çš„å¥åº·çŠ¶æ€
* **æˆå‘˜åˆ—è¡¨æ£€æŸ¥**ï¼šéªŒè¯æ‰€æœ‰èŠ‚ç‚¹æ˜¯å¦æ­£ç¡®åŠ å…¥é›†ç¾¤
* **ç«¯å£å¯è®¿é—®æ€§æµ‹è¯•**ï¼šç¡®ä¿ etcd å®¢æˆ·ç«¯å’Œé›†ç¾¤é€šä¿¡ç«¯å£æ­£å¸¸å·¥ä½œ

### ğŸ“Š ç›‘æ§ä¸çŠ¶æ€æŠ¥å‘Š

* **å¯åŠ¨çŠ¶æ€ç›‘æ§**ï¼šç­‰å¾… etcd å®¹å™¨æ­£å¸¸å¯åŠ¨å¹¶è¿è¡Œ
* **é›†ç¾¤çŠ¶æ€æŠ¥å‘Š**ï¼šæä¾›é›†ç¾¤æˆå‘˜çŠ¶æ€çš„è¯¦ç»†ä¿¡æ¯
* **ç«¯å£å¯ç”¨æ€§éªŒè¯**ï¼šç¡®ä¿ etcd æœåŠ¡ç«¯å£å¯æ­£å¸¸è®¿é—®

## ğŸ“ å˜é‡è¯´æ˜

### åŸºæœ¬é…ç½®å˜é‡


| å˜é‡å             | é»˜è®¤å€¼                      | è¯´æ˜                                      |
| ------------------ | --------------------------- | ----------------------------------------- |
| `etcd_deploy_mode` | `"manifest"`                | etcd éƒ¨ç½²æ¨¡å¼ï¼Œæ”¯æŒ`manifest`ï¼ˆé™æ€ Podï¼‰ |
| `etcd_data_dir`    | `/var/lib/etcd`             | etcd æ•°æ®å­˜å‚¨ç›®å½•                         |
| `etcd_version`     | `"3.5.16-0"`                | etcd å®¹å™¨é•œåƒç‰ˆæœ¬                         |
| `kube_base_dir`    | `/etc/kubernetes`           | Kubernetes é…ç½®åŸºç¡€ç›®å½•                   |
| `ca_dir`           | `"{{ kube_base_dir }}/pki"` | è¯ä¹¦å­˜å‚¨ç›®å½•                              |

### é•œåƒä¸å®¹å™¨é…ç½®


| å˜é‡å              | é»˜è®¤å€¼                      | è¯´æ˜                         |
| ------------------- | --------------------------- | ---------------------------- |
| `registry`          | `"registry.ikubeops.local"` | å®¹å™¨é•œåƒä»“åº“åœ°å€             |
| `registry_project`  | `"ikubeops"`                | é•œåƒä»“åº“é¡¹ç›®åç§°             |
| `etcd_image`        | è‡ªåŠ¨ç”Ÿæˆ                    | etcd å®¹å™¨é•œåƒå®Œæ•´è·¯å¾„        |
| `container_runtime` | `"containerd"`              | å®¹å™¨è¿è¡Œæ—¶ç±»å‹ï¼Œå½±å“æ£€æŸ¥å‘½ä»¤ |

### é›†ç¾¤é…ç½®å˜é‡


| å˜é‡å                 | é»˜è®¤å€¼      | è¯´æ˜                             |
| ---------------------- | ----------- | -------------------------------- |
| `etcd_initial_cluster` | åŠ¨æ€ç”Ÿæˆ    | åˆå§‹é›†ç¾¤é…ç½®ï¼Œä»ä¸»æœºæ¸…å•è‡ªåŠ¨ç”Ÿæˆ |
| `deploy_name`          | `"example"` | éƒ¨ç½²åç§°ï¼Œç”¨äºç»„ç»‡ç”Ÿæˆçš„æ–‡ä»¶     |

### è¯ä¹¦ç›¸å…³å˜é‡


| å˜é‡å               | é»˜è®¤å€¼    | è¯´æ˜               |
| -------------------- | --------- | ------------------ |
| `generate_certs_dir` | è‡ªåŠ¨ç”Ÿæˆ  | è¯ä¹¦ç”Ÿæˆç›®å½•è·¯å¾„   |
| `cfssl_version`      | `"1.6.5"` | CFSSL å·¥å…·ç‰ˆæœ¬     |
| `cfssl_dir`          | è‡ªåŠ¨ç”Ÿæˆ  | CFSSL å·¥å…·ç›®å½•è·¯å¾„ |

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

1. åœ¨æ‚¨çš„ Ansible æ¸…å•æ–‡ä»¶ä¸­å®šä¹‰ `etcd` ä¸»æœºç»„ï¼š

```ini
[etcd]
master-1 ansible_host=192.168.1.101
master-2 ansible_host=192.168.1.102
master-3 ansible_host=192.168.1.103
```

2. åœ¨ playbook ä¸­å¼•ç”¨è§’è‰²ï¼š

```yaml
- hosts: etcd
  roles:
    - etcd
```

### è‡ªå®šä¹‰é…ç½®ç¤ºä¾‹

```yaml
- hosts: etcd
  vars:
    etcd_version: "3.5.16-0"
    etcd_data_dir: "/opt/etcd/data"
    registry: "my-registry.example.com"
    registry_project: "kubernetes"
    container_runtime: "docker"  # å¦‚æœä½¿ç”¨ Docker è€Œé Containerd
  roles:
    - etcd
```

### é«˜å¯ç”¨éƒ¨ç½²ç¤ºä¾‹

```yaml
# éƒ¨ç½²å…·æœ‰3ä¸ªèŠ‚ç‚¹çš„é«˜å¯ç”¨ etcd é›†ç¾¤
- hosts: etcd
  vars:
    deploy_name: "production-cluster"
    kube_base_dir: "/etc/kubernetes"
    etcd_data_dir: "/var/lib/etcd-data"  # è‡ªå®šä¹‰æ•°æ®ç›®å½•
  roles:
    - etcd
```

### ä½¿ç”¨æ ‡ç­¾é€‰æ‹©æ€§æ‰§è¡Œä»»åŠ¡

```bash
# åªè¿è¡Œè¯ä¹¦ç›¸å…³ä»»åŠ¡
ansible-playbook -i inventory.ini main.yml --tags "certs"

# åªéªŒè¯ etcd é›†ç¾¤çŠ¶æ€
ansible-playbook -i inventory.ini main.yml --tags "verify"
```

### æ³¨æ„äº‹é¡¹

* etcd é›†ç¾¤åº”ç”±å¥‡æ•°ä¸ªèŠ‚ç‚¹ç»„æˆï¼ˆé€šå¸¸ä¸º 1ã€3ã€5 æˆ– 7 ä¸ªèŠ‚ç‚¹ï¼‰
* ä¸ºç¡®ä¿é›†ç¾¤ç¨³å®šæ€§ï¼Œå»ºè®®è‡³å°‘éƒ¨ç½² 3 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤
* etcd å¯¹ç£ç›˜ I/O æ€§èƒ½æ•æ„Ÿï¼Œå»ºè®®ä½¿ç”¨ SSD å­˜å‚¨
* é»˜è®¤æƒ…å†µä¸‹ï¼Œetcd ç›‘å¬ä»¥ä¸‹ç«¯å£ï¼š
  * 2379ï¼šå®¢æˆ·ç«¯é€šä¿¡ç«¯å£
  * 2380ï¼šé›†ç¾¤èŠ‚ç‚¹é€šä¿¡ç«¯å£
* ç¡®ä¿èŠ‚ç‚¹é—´ç½‘ç»œå»¶è¿Ÿä½ä¸”ç¨³å®š
* å®šæœŸå¤‡ä»½ etcd æ•°æ®

### éªŒè¯éƒ¨ç½²

éƒ¨ç½²å®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯ etcd é›†ç¾¤çŠ¶æ€ï¼š

```bash
# é€šè¿‡ etcdctl éªŒè¯é›†ç¾¤çŠ¶æ€
export ETCDCTL_API=3
etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/ca.pem \
  --cert=/etc/kubernetes/pki/etcd.pem \
  --key=/etc/kubernetes/pki/etcd-key.pem \
  member list -w table

# æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€
etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/ca.pem \
  --cert=/etc/kubernetes/pki/etcd.pem \
  --key=/etc/kubernetes/pki/etcd-key.pem \
  endpoint health --cluster
```

---

ğŸ”„ æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è€ƒ etcd å®˜æ–¹æ–‡æ¡£ï¼š[etcd.io](https://etcd.io/)
