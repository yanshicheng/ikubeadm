# Kube-CNI è§’è‰²

![ç½‘ç»œ](https://img.shields.io/badge/%E7%BD%91%E7%BB%9C-CNI-blue)![Calico](https://img.shields.io/badge/Calico-%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6-orange)![Kubernetes](https://img.shields.io/badge/Kubernetes-%E7%BD%91%E7%BB%9C-green)

## ğŸ“‹ ç®€ä»‹

`kube-cni` è§’è‰²è´Ÿè´£åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²å’Œé…ç½®å®¹å™¨ç½‘ç»œæ¥å£ï¼ˆCNIï¼‰æ’ä»¶ï¼Œç¡®ä¿é›†ç¾¤å†… Pod ä¹‹é—´çš„ç½‘ç»œé€šä¿¡ã€‚è¯¥è§’è‰²ä¸»è¦æ”¯æŒ Calico ç½‘ç»œæ’ä»¶ï¼Œæä¾›äº†çµæ´»çš„ç½‘ç»œæ¨¡å¼é€‰æ‹©å’Œé…ç½®é€‰é¡¹ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯ä¸‹çš„ç½‘ç»œéœ€æ±‚ã€‚

Calico æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€å¯æ‰©å±•çš„å¼€æºç½‘ç»œå’Œç½‘ç»œå®‰å…¨è§£å†³æ–¹æ¡ˆï¼Œä¸ºå®¹å™¨ã€è™šæ‹Ÿæœºå’Œæœ¬åœ°ä¸»æœºå·¥ä½œè´Ÿè½½æä¾›ç½‘ç»œè¿æ¥å’Œå®‰å…¨é˜²æŠ¤ã€‚é€šè¿‡è¯¥è§’è‰²ï¼Œæ‚¨å¯ä»¥è½»æ¾éƒ¨ç½² Calicoï¼Œå¹¶æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç½‘ç»œæ¨¡å¼ï¼ˆBGPã€VxLAN æˆ– IPIPï¼‰ã€‚

## ğŸ¯ é€‚ç”¨åœºæ™¯

* **æ–°å»º Kubernetes é›†ç¾¤**ï¼šä¸ºæ–°é›†ç¾¤æä¾›å®Œæ•´çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆ
* **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**ï¼šéœ€è¦é«˜æ€§èƒ½ã€å®‰å…¨å’Œå¯é ç½‘ç»œçš„ç”Ÿäº§ç¯å¢ƒ
* **å¤šåŒºåŸŸ/å¤šæ•°æ®ä¸­å¿ƒé›†ç¾¤**ï¼šéœ€è¦è·¨åŒºåŸŸè·¯ç”±çš„å¤§å‹é›†ç¾¤ç¯å¢ƒ
* **å¾®æœåŠ¡æ¶æ„**ï¼šéœ€è¦ç»†ç²’åº¦ç½‘ç»œç­–ç•¥æ§åˆ¶çš„å¾®æœåŠ¡åº”ç”¨
* **ç½‘ç»œè¿ç§»**ï¼šä»å…¶ä»– CNI æ’ä»¶è¿ç§»åˆ° Calico
* **BGP ç½‘ç»œé›†æˆ**ï¼šéœ€è¦ä¸ç°æœ‰ BGP ç½‘ç»œåŸºç¡€è®¾æ–½é›†æˆçš„ç¯å¢ƒ
* **ç½‘ç»œéš”ç¦»è¦æ±‚**ï¼šéœ€è¦ä¸¥æ ¼ç½‘ç»œéš”ç¦»å’Œå®‰å…¨ç­–ç•¥çš„å¤šç§Ÿæˆ·ç¯å¢ƒ
* **é«˜æ€§èƒ½è®¡ç®—**ï¼šå¯¹ç½‘ç»œæ€§èƒ½æœ‰ä¸¥æ ¼è¦æ±‚çš„å·¥ä½œè´Ÿè½½

## âœ¨ åŠŸèƒ½è¯´æ˜

### ğŸŒ ç½‘ç»œæ¨¡å¼æ”¯æŒ

* **BGP æ¨¡å¼**ï¼š
  * ä½¿ç”¨ BGP åè®®åœ¨èŠ‚ç‚¹é—´ç›´æ¥è·¯ç”±æ•°æ®åŒ…
  * æ”¯æŒ Route Reflector é…ç½®ï¼Œä¼˜åŒ–å¤§å‹é›†ç¾¤ä¸­çš„è·¯ç”±é€šå‘Š
  * å…è®¸è‡ªå®šä¹‰ AS å·é…ç½®ä¸å¤–éƒ¨ç½‘ç»œé›†æˆ
* **VxLAN æ¨¡å¼**ï¼š
  * ä½¿ç”¨ UDP å°è£…åœ¨ Layer 2 ç½‘ç»œä¸Šå»ºç«‹ Layer 3 Overlay ç½‘ç»œ
  * é€‚ç”¨äºä¸æ”¯æŒ BGP çš„ç¯å¢ƒ
  * è‡ªåŠ¨è§£å†³è™šæ‹ŸåŒ–ç¯å¢ƒä¸­çš„ç«¯å£å†²çªé—®é¢˜
* **IPIP æ¨¡å¼**ï¼š
  * ä½¿ç”¨ IP-in-IP å°è£…æŠ€æœ¯
  * åœ¨ä¸æ”¯æŒ BGP çš„ç¯å¢ƒä¸­æä¾›æ›´å¥½çš„æ€§èƒ½è¡¨ç°

### ğŸ”§ éƒ¨ç½²ä¸é…ç½®

* **YAML æ¸…å•éƒ¨ç½²**ï¼šä½¿ç”¨ Kubernetes åŸç”Ÿæ¸…å•æ–‡ä»¶éƒ¨ç½²ç»„ä»¶
* **ç»„ä»¶åˆ†æ­¥éƒ¨ç½²**ï¼šæŒ‰ç…§æ­£ç¡®é¡ºåºéƒ¨ç½²å„ä¸ª Calico ç»„ä»¶
* **äºŒè¿›åˆ¶å·¥å…·åˆ†å‘**ï¼šéƒ¨ç½² calicoctl å‘½ä»¤è¡Œå·¥å…·ï¼Œä¾¿äºç®¡ç† Calico èµ„æº
* **è‡ªåŠ¨çŠ¶æ€æ£€æŸ¥**ï¼šéƒ¨ç½²åè‡ªåŠ¨éªŒè¯å„ç»„ä»¶çŠ¶æ€

### ğŸ” ç½‘ç»œç­–ç•¥ä¸å®‰å…¨

* **ç½‘ç»œç­–ç•¥æ”¯æŒ**ï¼šé€šè¿‡éƒ¨ç½²æ§åˆ¶å™¨ç»„ä»¶æ”¯æŒ Kubernetes NetworkPolicy
* **å®Œæ•´ RBAC æ”¯æŒ**ï¼šé…ç½®æ‰€éœ€çš„è§’è‰²å’Œæƒé™
* **èŠ‚ç‚¹-èŠ‚ç‚¹å®‰å…¨é€šä¿¡**ï¼šä¿éšœé›†ç¾¤å†…é€šä¿¡å®‰å…¨

### ğŸ”„ BGP é«˜çº§é…ç½®

* **Route Reflector æ¨¡å¼**ï¼šæ”¯æŒåœ¨å¤§å‹é›†ç¾¤ä¸­ä¼˜åŒ– BGP è·¯ç”±
* **è‡ªå®šä¹‰ BGP å¯¹ç­‰ä½“**ï¼šæ”¯æŒé…ç½®ä¸å¤–éƒ¨è·¯ç”±å™¨çš„ BGP å¯¹ç­‰å…³ç³»
* **AS å·é…ç½®**ï¼šè‡ªå®šä¹‰ BGP AS å·ä»¥åŒ¹é…ç°æœ‰ç½‘ç»œ

## ğŸ“ å˜é‡è¯´æ˜

### åŸºç¡€é…ç½®å˜é‡


| å˜é‡å                  | é»˜è®¤å€¼            | è¯´æ˜                         |
| ----------------------- | ----------------- | ---------------------------- |
| `base_dir`              | `/opt/kubernetes` | Kubernetes äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½•    |
| `pod_cidr`              | `10.244.0.0/16`   | Pod ç½‘ç»œ CIDR                |
| `service_cidr`          | `10.96.0.0/12`    | æœåŠ¡ç½‘ç»œ CIDR                |
| `addon_deploy_pattern`  | `yaml`            | éƒ¨ç½²æ¨¡å¼ï¼Œæ”¯æŒ`yaml`æˆ–`helm` |
| `cluster_cni_namespace` | `calico-system`   | CNI ç»„ä»¶éƒ¨ç½²å‘½åç©ºé—´         |
| `block_size`            | `24`              | æ¯ä¸ªèŠ‚ç‚¹çš„å­ç½‘æ©ç å¤§å°       |

### Calico é…ç½®å˜é‡


| å˜é‡å             | é»˜è®¤å€¼    | è¯´æ˜                                    |
| ------------------ | --------- | --------------------------------------- |
| `calico_version`   | `v3.29.3` | Calico ç‰ˆæœ¬                             |
| `calico_interface` | `""`      | Calico ä½¿ç”¨çš„ç½‘ç»œæ¥å£ï¼ˆä¸ºç©ºåˆ™è‡ªåŠ¨æ£€æµ‹ï¼‰ |
| `calico_mode`      | `bgp`     | ç½‘ç»œæ¨¡å¼ï¼Œå¯é€‰`bgp`ã€`vxlan`æˆ–`ipip`    |
| `calico_bgp_rr`    | `true`    | æ˜¯å¦å¯ç”¨ BGP Route Reflector            |
| `calico_mtu`       | `0`       | MTU å€¼ï¼ˆ0è¡¨ç¤ºè‡ªåŠ¨æ£€æµ‹ï¼‰                 |
| `calico_as_number` | `64512`   | BGP AS å·                               |

### é•œåƒé…ç½®å˜é‡


| å˜é‡å                          | é»˜è®¤å€¼                    | è¯´æ˜                  |
| ------------------------------- | ------------------------- | --------------------- |
| `registry`                      | `registry.ikubeops.local` | å®¹å™¨é•œåƒä»“åº“åœ°å€      |
| `registry_project`              | `ikubeops`                | é•œåƒä»“åº“é¡¹ç›®å        |
| `calico_registry_project`       | `calico`                  | Calico é•œåƒé¡¹ç›®å     |
| `calico_node_image`             | è‡ªåŠ¨ç”Ÿæˆ                  | Calico Node ç»„ä»¶é•œåƒ  |
| `cni_image`                     | è‡ªåŠ¨ç”Ÿæˆ                  | CNI æ’ä»¶é•œåƒ          |
| `calico_typha_image`            | è‡ªåŠ¨ç”Ÿæˆ                  | Calico Typha ç»„ä»¶é•œåƒ |
| `calico_kube_controllers_image` | è‡ªåŠ¨ç”Ÿæˆ                  | Calico æ§åˆ¶å™¨é•œåƒ     |

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

1. åœ¨ Ansible æ¸…å•æ–‡ä»¶ä¸­å®šä¹‰ Kubernetes ä¸»æœºç»„ï¼š

```ini
[ikube_master]
master-1 ansible_host=192.168.1.101
master-2 ansible_host=192.168.1.102
master-3 ansible_host=192.168.1.103

[ikube_node]
node-1 ansible_host=192.168.1.111
node-2 ansible_host=192.168.1.112
```

2. åœ¨ playbook ä¸­å¼•ç”¨è§’è‰²ï¼š

```yaml
- hosts: ikube_master
  vars:
    cluster_cni_mode: "calico"
  roles:
    - kube-cni
```

### ä½¿ç”¨ BGP æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

```yaml
- hosts: ikube_master
  vars:
    cluster_cni_mode: "calico"
    calico_mode: "bgp"
    calico_as_number: "64512"
  roles:
    - kube-cni
```

### ä½¿ç”¨ VxLAN æ¨¡å¼

åœ¨ä¸æ”¯æŒ BGP çš„ç¯å¢ƒä¸­ï¼Œå¯ä»¥ä½¿ç”¨ VxLAN æ¨¡å¼ï¼š

```yaml
- hosts: ikube_master
  vars:
    cluster_cni_mode: "calico"
    calico_mode: "vxlan"
  roles:
    - kube-cni
```

### é…ç½® BGP Route Reflector

å¯¹äºå¤§å‹é›†ç¾¤ï¼Œå¯ä»¥é…ç½® BGP Route Reflector ä¼˜åŒ–è·¯ç”±é€šå‘Šï¼š

1. åœ¨æ¸…å•æ–‡ä»¶ä¸­å®šä¹‰ Route Reflector èŠ‚ç‚¹ï¼š

```ini
[calico_rr_group]
master-1
```

2. åœ¨ playbook ä¸­å¯ç”¨ Route Reflectorï¼š

```yaml
- hosts: ikube_master
  vars:
    cluster_cni_mode: "calico"
    calico_mode: "bgp"
    calico_bgp_rr: true
  roles:
    - kube-cni
```

### è‡ªå®šä¹‰ç½‘ç»œé…ç½®

```yaml
- hosts: ikube_master
  vars:
    cluster_cni_mode: "calico"
    pod_cidr: "172.16.0.0/16"
    block_size: "26"
    calico_mtu: "1500"
    calico_interface: "ens192"  # æŒ‡å®šç½‘ç»œæ¥å£
  roles:
    - kube-cni
```

### é«˜çº§ BGP é…ç½®ç¤ºä¾‹

```yaml
- hosts: ikube_master
  vars:
    cluster_cni_mode: "calico"
    calico_mode: "bgp"
    calico_as_number: "65001"
    calico_bgp_rr: true
  roles:
    - kube-cni
```

### éƒ¨ç½²åéªŒè¯

éƒ¨ç½²å®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯ Calico æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

```bash
# æ£€æŸ¥æ‰€æœ‰ Calico Pod çŠ¶æ€
kubectl get pods -n calico-system

# æ£€æŸ¥èŠ‚ç‚¹ BGP çŠ¶æ€ï¼ˆBGP æ¨¡å¼ï¼‰
calicoctl node status

# æŸ¥çœ‹å·²å»ºç«‹çš„ BGP å¯¹ç­‰å…³ç³»
calicoctl get bgpPeer -o wide

# éªŒè¯ç½‘ç»œè¿é€šæ€§
kubectl run -it --rm ping --image=busybox -- ping <Pod IP>
```

### æ³¨æ„äº‹é¡¹

* **ç½‘ç»œæ¨¡å¼é€‰æ‹©**ï¼š
  * BGP æ¨¡å¼æ€§èƒ½æœ€ä½³ï¼Œä½†éœ€è¦ç¯å¢ƒæ”¯æŒ BGP åè®®
  * VxLAN æ¨¡å¼å…¼å®¹æ€§æœ€å¥½ï¼Œé€‚ç”¨äºå¤§å¤šæ•°ç¯å¢ƒ
  * IPIP æ¨¡å¼æ˜¯ BGP ä¸ VxLAN çš„æŠ˜ä¸­æ–¹æ¡ˆ
* **èŠ‚ç‚¹æ ‡è®°**ï¼š
  * å¦‚æœä½¿ç”¨ Route Reflectorï¼Œç¡®ä¿ç›¸å…³èŠ‚ç‚¹å·²æ­£ç¡®æ ‡è®°
  * æ ‡è®°å¯é€šè¿‡ `calico_rr_group` ä¸»æœºç»„è‡ªåŠ¨å¤„ç†
* **ç½‘ç»œæ¥å£**ï¼š
  * å¦‚æœä¸æŒ‡å®š `calico_interface`ï¼ŒCalico å°†è‡ªåŠ¨é€‰æ‹©é»˜è®¤æ¥å£
  * åœ¨å¤šç½‘å¡ç¯å¢ƒä¸­ï¼Œå»ºè®®æ˜ç¡®æŒ‡å®šæ¥å£åç§°
* **MTU è®¾ç½®**ï¼š
  * ä¸åŒçš„ç½‘ç»œæ¨¡å¼å¯èƒ½éœ€è¦ä¸åŒçš„ MTU è®¾ç½®
  * VXLAN å’Œ IPIP æ¨¡å¼é€šå¸¸éœ€è¦æ¯”æ ‡å‡† MTU å° 50-100 å­—èŠ‚
* **é˜²ç«å¢™é…ç½®**ï¼š
  * ç¡®ä¿èŠ‚ç‚¹é—´å…è®¸ Calico æ‰€éœ€çš„ç½‘ç»œæµé‡
  * BGP æ¨¡å¼éœ€è¦å…è®¸ TCP ç«¯å£ 179
  * VxLAN æ¨¡å¼é»˜è®¤ä½¿ç”¨ UDP ç«¯å£ 4789ï¼ˆåœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸­ä¼šè‡ªåŠ¨ä¿®æ”¹ä¸º 4799ï¼‰

---

ğŸ”„ é€šè¿‡æ­£ç¡®é…ç½®å’Œéƒ¨ç½² kube-cni è§’è‰²ï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªé«˜æ€§èƒ½ã€å®‰å…¨å¯é çš„ Kubernetes ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œä¸ºé›†ç¾¤æä¾›åšå®çš„ç½‘ç»œåŸºç¡€ã€‚
