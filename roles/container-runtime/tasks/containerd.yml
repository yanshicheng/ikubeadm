---
# ==========================================================================
# Containerdå®‰è£…ä»»åŠ¡æ–‡ä»¶
# åŒ…å«ContainerdåŠå…¶ç»„ä»¶çš„å®‰è£…ã€é…ç½®å’ŒæœåŠ¡ç®¡ç†
# ==========================================================================

- name: åˆ›å»ºå¿…è¦çš„ç›®å½•
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
  - /etc/containerd
  - /etc/containerd/certs.d
  - "{{ base_dir }}/containerd"
  - "{{ base_dir }}/cni/bin"
  - "{{ base_dir }}/cni/cache"
  - "/etc/cni/net.d"
  - "{{ base_dir }}/nri/plugins"
  - "{{ base_dir }}/nri/conf.d"
  - /var/run/nri
  - /run/nri
  - /var/run/containerd/
  - /run/containerd/
  - /etc/buildkit
  - /etc/nerdctl
  tags:
  - install

- name: å®‰è£… CNI æ’ä»¶
  ansible.builtin.unarchive:
    src: "{{ cni_plugins_package }}"
    dest: "{{ base_dir }}/cni/bin"
    mode: '0755'
  register: cni_install
  tags:
  - install
  - cni

# æ·»åŠ ç¯å¢ƒå˜é‡é…ç½®
- name: æ·»åŠ äºŒè¿›åˆ¶ç›®å½•åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡
  lineinfile:
    path: /etc/profile.d/999-ikubesop-k8s.sh
    regexp: '^export PATH={{ base_dir }}/bin:\$PATH'
    line: 'export PATH={{ base_dir }}/bin:$PATH'
    create: yes
    mode: 644
  tags: kubernetes_env

- name: åˆ†å‘ containerd å·¥å…·
  ansible.builtin.unarchive:
    src: "{{ containerd_package }}"
    dest: "{{ base_dir }}/"
  failed_when: false
  register: containerd_extract
  tags:
  - install

- name: åˆ†å‘ crictl å·¥å…·
  ansible.builtin.unarchive:
    src: "{{ crictl_package }}"
    dest: "{{ base_dir }}/bin"
    mode: '0755'
  register: crictl_install
  tags:
  - install
  - crictl

- name: ç”Ÿæˆä»“åº“åˆ—è¡¨
  ansible.builtin.set_fact:
    registry_list: >-
      {{ container_insecure_registries | default([]) | map(attribute='hosts') | list + ['http://registry.ikubeops.local:5000'] | unique }}
    cert_required_registries: >-
      {{ container_insecure_registries | default([]) | selectattr('cert_auth', 'defined') | selectattr('cert_auth') | map(attribute='hosts') | list }}
  delegate_to: localhost
  run_once: true

# æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- name: æ£€æŸ¥ä»“åº“è¯ä¹¦æ–‡ä»¶
  ansible.builtin.stat:
    path: "{{ registry_certs_dir }}/{{ item | regex_replace('https?://(.+)(:.*)?', '\\1') }}"
  register: cert_check
  loop: "{{ cert_required_registries }}"
  delegate_to: localhost
  run_once: true

- name: ç¼ºå°‘ä»“åº“ ca è¯ä¹¦
  ansible.builtin.fail:
    msg: |
      ä»¥ä¸‹ä»“åº“é…ç½®äº† cert_auth=true ä½†æ‰¾ä¸åˆ°è¯ä¹¦æ–‡ä»¶:
      {% for result in cert_check.results %}
        {% if not result.stat.exists %}
          - {{ result.item }}
          è¯·åœ¨ {{ registry_certs_dir }}/{{ result.item | regex_replace('https?://(.+)(:.*)?', '\1') }}  ç›®å½•æ”¾ç½®ca.crtæ–‡ä»¶
           æˆ–è€…å°†æ­¤ä»“åº“çš„ cert_auth è®¾ç½®ä¸º false
        {% endif %}
      {% endfor %}
  when: cert_check.results | selectattr('stat.exists', 'equalto', false) | list | length > 0
  delegate_to: localhost
  run_once: true

- name: åˆ›å»ºä»“åº“è¯ä¹¦ç›®å½•
  ansible.builtin.file:
    path: "/etc/containerd/certs.d/{{ item | regex_replace('https?://(.+)(:.*)?', '\\1') }}"
    state: directory
    mode: '0755'
  loop: "{{ registry_list }}"

# ä¸ºæ¯ä¸ªæ³¨å†Œè¡¨åˆ›å»ºhosts.tomlé…ç½®
- name: ç”Ÿæˆä»“åº“ hosts.toml æ–‡ä»¶
  ansible.builtin.template:
    src: "containerd/hosts.toml.j2"
    dest: "/etc/containerd/certs.d/{{ item | regex_replace('https?://(.+)(:.*)?', '\\1') }}/hosts.toml"
    mode: '0644'
  vars:
    registry_url: "{{ item }}"
  loop: "{{ registry_list }}"

# åˆ†å‘ä»“åº“è¯ä¹¦
- name: åˆ†å‘ä»“åº“ ca è¯ä¹¦
  ansible.builtin.copy:
    src: "{{ registry_certs_dir }}/{{ item | regex_replace('https?://(.+)(:.*)?', '\\1') }}/ca.crt"
    dest: "/etc/containerd/certs.d/{{ item | regex_replace('https?://(.+)(:.*)?', '\\1') }}/ca.crt"
    mode: '0644'
  loop: "{{ cert_required_registries }}"
  when: cert_required_registries | length > 0

- name: ç”Ÿæˆ containerd systemd æœåŠ¡æ–‡ä»¶
  ansible.builtin.template:
    src: containerd/containerd.service.j2
    dest: /etc/systemd/system/containerd.service
    mode: '0644'
    backup: yes
  register: containerd_service
  tags:
  - config

- name: ç”Ÿæˆ containerd é…ç½®æ–‡ä»¶
  ansible.builtin.template:
    src: containerd/config.toml.j2
    dest: /etc/containerd/config.toml
    mode: '0644'
    backup: yes
  register: containerd_config
  notify: start_and_enable_container_runtime
  tags:
  - config

- name: ç”Ÿæˆ crictl é…ç½®æ–‡ä»¶
  ansible.builtin.template:
    src: containerd/crictl.yaml.j2
    dest: /etc/crictl.yaml
    mode: '0644'
    backup: yes
  tags:
  - config

# å®‰è£… nerdctlï¼ˆå¯é€‰ï¼‰
- name: å®‰è£… nerdctl å·¥å…·
  block:
  - name: åˆ†å‘ nerdctl å·¥å…·
    ansible.builtin.unarchive:
      src: "{{ nerdctl_package }}"
      dest: "{{ base_dir }}/bin"
      mode: '0755'
    register: nerdctl_install

  - name: ç”Ÿæˆ nerdctl é…ç½®æ–‡ä»¶
    ansible.builtin.template:
      src: containerd/nerdctl.toml.j2
      dest: /etc/nerdctl/nerdctl.toml
  when: install_nerdctl | default(true)
  tags:
  - install
  - nerdctl

# å®‰è£… buildkitï¼ˆå¯é€‰ï¼‰

- name: å®‰è£… buildkit
  block:
  - name: åˆ†å‘ buildkit å·¥å…·
    ansible.builtin.unarchive:
      src: "{{ buildkit_package }}"
      dest: "{{ base_dir }}/"
    register: buildkit_extract

  - name: ç”Ÿæˆ buildkitd é…ç½®æ–‡ä»¶
    ansible.builtin.template:
      src: containerd/buildkitd.toml.j2
      dest: /etc/buildkit/buildkitd.toml
      mode: '0644'
      backup: yes
    register: buildkit_config
  tags:
  - install
  - buildkit
  when: install_buildkit | default(true)

- name: å¯åŠ¨ containerd æœåŠ¡
  ansible.builtin.systemd:
    name: "{{ container_runtime }}"
    state: started
    enabled: yes
    daemon_reload: yes

- name: è½®è¯¢ç­‰å¾… containerd æœåŠ¡è¿è¡Œ
  ansible.builtin.shell: "systemctl is-active containerd.service"
  register: cri_docker_status
  until: '"active" in cri_docker_status.stdout'
  retries: 8
  delay: 2
  changed_when: false
  tags:
  - service
  - upgrade_docker

- name: æ˜¾ç¤ºæœåŠ¡å®‰è£…å’Œå¯åŠ¨æ€»ç»“
  ansible.builtin.debug:
    msg:
    - "============================================================"
    - "Containerd éƒ¨ç½²çŠ¶æ€æŠ¥å‘Š"
    - "============================================================"
    - "åŸºç¡€æœåŠ¡çŠ¶æ€ï¼š"
    - "{{ 'âœ… Containerd: ' + cri_docker_status.stdout if cri_docker_status is defined else 'â“ Containerd: çŠ¶æ€æœªæ£€æµ‹' }}"
    - "ğŸ“ å®‰è£…ç›®å½•: {{ base_dir | default('/opt/kube') }}/bin"
    - ""
    - "ç»„ä»¶å®‰è£…çŠ¶æ€ï¼š"
    - "{{ 'âœ… crictl: ' + ('å·²å®‰è£… (æ–°)' if crictl_install.changed else 'å·²å­˜åœ¨ (æ— å˜åŒ–)') if crictl_install is defined else 'â“ crictl: å®‰è£…çŠ¶æ€æœªçŸ¥' }}"
    - "{{ 'âœ… containerd: ' + ('å·²å®‰è£… (æ–°)' if containerd_extract.changed else 'å·²å­˜åœ¨ (æ— å˜åŒ–)') if containerd_extract is defined else 'â“ containerd: å®‰è£…çŠ¶æ€æœªçŸ¥' }}"
    - "{{ 'âœ… nerdctl: ' + ('å·²å®‰è£… (æ–°)' if nerdctl_install.changed else 'å·²å­˜åœ¨ (æ— å˜åŒ–)') if nerdctl_install is defined else 'âŒ nerdctl: æœªå®‰è£… (é…ç½®å·²ç¦ç”¨)' if not install_nerdctl | default(true) else 'â“ nerdctl: å®‰è£…çŠ¶æ€æœªçŸ¥' }}"
    - "{{ 'âœ… buildkit: ' + ('å·²å®‰è£… (æ–°)' if buildkit_extract.changed else 'å·²å­˜åœ¨ (æ— å˜åŒ–)') if buildkit_extract is defined else 'âŒ buildkit: æœªå®‰è£… (é…ç½®å·²ç¦ç”¨)' if not install_buildkit | default(true) else 'â“ buildkit: å®‰è£…çŠ¶æ€æœªçŸ¥' }}"
    - ""
    - "é…ç½®æ–‡ä»¶çŠ¶æ€ï¼š"
    - "{{ 'âœ… ä¸»é…ç½®: ' + ('å·²æ›´æ–°' if containerd_config.changed else 'æ— å˜åŒ–') if containerd_config is defined else 'â“ ä¸»é…ç½®: çŠ¶æ€æœªçŸ¥' }}"
    - "{{ 'âœ… æœåŠ¡å•å…ƒ: ' + ('å·²æ›´æ–°' if containerd_service.changed else 'æ— å˜åŒ–') if containerd_service is defined else 'â“ æœåŠ¡å•å…ƒ: çŠ¶æ€æœªçŸ¥' }}"
    - ""
    - "ç½‘ç»œé…ç½®ï¼š"
    - "ğŸ“ CNI ç›®å½•: {{ base_dir | default('/opt/kube') }}/cni/bin"
    - "ğŸ“ CNI é…ç½®: /etc/cni/net.d"
    - ""
    - "==========================================================="
    - "éƒ¨ç½²å®Œæˆï¼éªŒè¯å‘½ä»¤ï¼šcrictl info | nerdctl info"
    - "==========================================================="
  tags:
  - summary
