# Kubernetes è¯ä¹¦ç”Ÿæˆå™¨è§’è‰² (cert-generator)

# Cert-Manager è§’è‰²

![è¯ä¹¦ç®¡ç†](https://img.shields.io/badge/%E8%AF%81%E4%B9%A6%E7%AE%A1%E7%90%86-Cert--Manager-blue)![Kubernetes](https://img.shields.io/badge/Kubernetes-%E8%AF%81%E4%B9%A6-orange)![CFSSL](https://img.shields.io/badge/CFSSL-TLS-green)

## ğŸ“‹ ç®€ä»‹

`cert-manager` è§’è‰²è´Ÿè´£ä¸º Kubernetes é›†ç¾¤ç”Ÿæˆå’Œç®¡ç† TLS è¯ä¹¦ï¼Œè¿™äº›è¯ä¹¦å¯¹äºç¡®ä¿é›†ç¾¤ç»„ä»¶ä¹‹é—´çš„å®‰å…¨é€šä¿¡è‡³å…³é‡è¦ã€‚è¯¥è§’è‰²ä½¿ç”¨ CFSSLï¼ˆCloudFlare çš„ SSL å·¥å…·åŒ…ï¼‰ä½œä¸ºè¯ä¹¦ç”Ÿæˆå·¥å…·ï¼Œè‡ªåŠ¨åŒ–åˆ›å»ºæ‰€æœ‰å¿…è¦çš„è¯ä¹¦å’Œ kubeconfig é…ç½®æ–‡ä»¶ï¼Œä»¥å»ºç«‹ Kubernetes é›†ç¾¤æ‰€éœ€çš„ PKIï¼ˆå…¬é’¥åŸºç¡€è®¾æ–½ï¼‰ã€‚

é€šè¿‡è¿™ä¸ªè§’è‰²ï¼Œæ‚¨å¯ä»¥è½»æ¾ç®¡ç†è¯ä¹¦çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬åˆå§‹åˆ›å»ºã€æ›´æ–°å’Œè½®æ¢ï¼Œç¡®ä¿æ‚¨çš„ Kubernetes é›†ç¾¤å§‹ç»ˆä½¿ç”¨æœ‰æ•ˆçš„ã€å®‰å…¨çš„ TLS è¯ä¹¦ã€‚

## ğŸ¯ é€‚ç”¨åœºæ™¯

* **åˆå§‹ Kubernetes é›†ç¾¤éƒ¨ç½²**ï¼šä¸ºæ–°é›†ç¾¤è®¾ç½®å®Œæ•´çš„ PKI åŸºç¡€è®¾æ–½
* **è¯ä¹¦æ›´æ–°**ï¼šåœ¨è¯ä¹¦æ¥è¿‘è¿‡æœŸæ—¶è¿›è¡Œæ›´æ–°
* **ç¾éš¾æ¢å¤**ï¼šåœ¨è¯ä¹¦ä¸¢å¤±æˆ–æŸååé‡æ–°ç”Ÿæˆè¯ä¹¦
* **é›†ç¾¤æ‰©å±•**ï¼šä¸ºæ–°æ·»åŠ çš„èŠ‚ç‚¹ç”Ÿæˆæ‰€éœ€çš„è¯ä¹¦
* **Kubernetes ç‰ˆæœ¬å‡çº§**ï¼šåœ¨å‡çº§è¿‡ç¨‹ä¸­å¯èƒ½éœ€è¦æ›´æ–°è¯ä¹¦
* **å®‰å…¨ç­–ç•¥å¼ºåŒ–**ï¼šæ›´æ–°è¯ä¹¦é…ç½®ä»¥ç¬¦åˆæœ€æ–°çš„å®‰å…¨æ ‡å‡†
* **é›†ç¾¤ç»´æŠ¤**ï¼šå®šæœŸè½®æ¢è¯ä¹¦ä½œä¸ºå®‰å…¨æœ€ä½³å®è·µ

## âœ¨ åŠŸèƒ½è¯´æ˜

### ğŸ” è¯ä¹¦ç”ŸæˆåŠŸèƒ½

* **æ ¹è¯ä¹¦é¢å‘æœºæ„ (CA)**ï¼šåˆ›å»ºè‡ªç­¾å CA è¯ä¹¦ï¼Œç”¨äºç­¾ç½²æ‰€æœ‰å…¶ä»–è¯ä¹¦
* **API æœåŠ¡å™¨è¯ä¹¦**ï¼šä¸º kube-apiserver ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
* **å®¢æˆ·ç«¯è¯ä¹¦**ï¼šä¸ºå„ä¸ª Kubernetes ç»„ä»¶ç”Ÿæˆå®¢æˆ·ç«¯è®¤è¯è¯ä¹¦ï¼ŒåŒ…æ‹¬ï¼š
  * admin ç”¨æˆ·è¯ä¹¦
  * kube-controller-manager è¯ä¹¦
  * kube-scheduler è¯ä¹¦
  * kube-proxy è¯ä¹¦
  * kubelet èŠ‚ç‚¹è¯ä¹¦ï¼ˆä¸ºé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹å•ç‹¬ç”Ÿæˆï¼‰
  * aggregator-proxy è¯ä¹¦ï¼ˆç”¨äº API èšåˆï¼‰

### ğŸ“„ é…ç½®æ–‡ä»¶ç”Ÿæˆ

* **kubeconfig æ–‡ä»¶**ï¼šä¸ºå„ç»„ä»¶è‡ªåŠ¨ç”Ÿæˆ kubeconfig é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬ï¼š
  * admin.kubeconfig
  * kube-controller-manager.kubeconfig
  * kube-scheduler.kubeconfig
  * kube-proxy.kubeconfig
  * å„èŠ‚ç‚¹çš„ kubelet.kubeconfig

### ğŸ”„ è¯ä¹¦ç”Ÿå‘½å‘¨æœŸç®¡ç†

* **è¯ä¹¦æ›´æ–°æ¨¡å¼**ï¼šæ”¯æŒå¤šç§æ›´æ–°ç­–ç•¥
  * ä»…æ›´æ–° CA è¯ä¹¦
  * ä»…æ›´æ–°ç»„ä»¶è¯ä¹¦
  * æ›´æ–°æ‰€æœ‰è¯ä¹¦
  * ä¸æ›´æ–°ä»»ä½•è¯ä¹¦ï¼ˆé»˜è®¤ï¼‰
* **è¯ä¹¦å¤‡ä»½**ï¼šæ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½ç°æœ‰è¯ä¹¦å’Œé…ç½®
* **è¯ä¹¦æœ‰æ•ˆæœŸè®¾ç½®**ï¼šå¯è‡ªå®šä¹‰ CA å’Œç»„ä»¶è¯ä¹¦çš„æœ‰æ•ˆæœŸ

### ğŸ› ï¸ ç³»ç»Ÿå‡†å¤‡å’ŒéªŒè¯

* **å·¥å…·æ£€æŸ¥**ï¼šéªŒè¯å¿…è¦å·¥å…·ï¼ˆcfsslã€cfssljsonã€kubectlï¼‰æ˜¯å¦å·²å®‰è£…
* **ç›®å½•å‡†å¤‡**ï¼šè‡ªåŠ¨åˆ›å»ºæ‰€éœ€çš„ç›®å½•ç»“æ„
* **å®ŒæˆéªŒè¯**ï¼šç”Ÿæˆè¿‡ç¨‹å®Œæˆåæä¾›çŠ¶æ€æŠ¥å‘Š

## ğŸ“ å˜é‡è¯´æ˜

### åŸºç¡€é…ç½®å˜é‡


| å˜é‡å               | é»˜è®¤å€¼      | è¯´æ˜                                              |
| -------------------- | ----------- | ------------------------------------------------- |
| `deploy_name`        | `"example"` | éƒ¨ç½²åç§°ï¼Œç”¨äºå¤šé›†ç¾¤ç®¡ç†                          |
| `kubernetes_version` | `"v1.32.3"` | Kubernetes ç‰ˆæœ¬ ç”Ÿæˆ kubeconfig è°ƒç”¨ kubelet å·¥å…· |
| `cfssl_version`      | `"1.6.5"`   | CFSSL å·¥å…·ç‰ˆæœ¬                                    |

### API æœåŠ¡å™¨é…ç½®


| å˜é‡å                   | é»˜è®¤å€¼           | è¯´æ˜                     |
| ------------------------ | ---------------- | ------------------------ |
| `kube_apiserver_lb_addr` | `"127.0.0.1"`    | API æœåŠ¡å™¨è´Ÿè½½å‡è¡¡å™¨åœ°å€ |
| `kube_apiserver_lb_port` | `"6443"`         | API æœåŠ¡å™¨ç«¯å£           |
| `service_cidr`           | `"10.96.0.0/12"` | æœåŠ¡ç½‘æ®µ CIDR            |

### è¯ä¹¦é…ç½®


| å˜é‡å              | é»˜è®¤å€¼      | è¯´æ˜                                                                                                                              |
| ------------------- | ----------- | --------------------------------------------------------------------------------------------------------------------------------- |
| `cert_update_mode`  | `"none"`    | è¯ä¹¦æ›´æ–°æ¨¡å¼ï¼š<br>`none`- ä¸æ›´æ–°ä»»ä½•è¯ä¹¦<br>`ca_only`- åªæ›´æ–° CA è¯ä¹¦<br>`components_only`- åªæ›´æ–°ç»„ä»¶è¯ä¹¦<br>`all`- æ›´æ–°æ‰€æœ‰è¯ä¹¦ |
| `ca_expiry`         | `"876000h"` | CA è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆ100å¹´ï¼‰                                                                                                            |
| `cert_expiry`       | `"8760h"`   | ç»„ä»¶è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆ1å¹´ï¼‰                                                                                                             |
| `master_cert_hosts` | `[]`        | API æœåŠ¡å™¨è¯ä¹¦ä¸­çš„é¢å¤–ä¸»æœºå                                                                                                      |

### é›†ç¾¤é…ç½®


| å˜é‡å         | é»˜è®¤å€¼         | è¯´æ˜                      |
| -------------- | -------------- | ------------------------- |
| `cluster_name` | `"kubernetes"` | kubeconfig ä¸­çš„é›†ç¾¤åç§°   |
| `context_name` | `"default"`    | kubeconfig ä¸­çš„ä¸Šä¸‹æ–‡åç§° |

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

1. åœ¨ playbook ä¸­å¼•ç”¨è§’è‰²ï¼š

```yaml
- hosts: localhost
  roles:
    - cert-manager
```

2. ä½¿ç”¨é»˜è®¤è®¾ç½®ç”Ÿæˆè¯ä¹¦ï¼š

```bash
ansible-playbook -i inventory cert-playbook.yml
```

### åˆå§‹è¯ä¹¦ç”Ÿæˆ

```yaml
- hosts: localhost
  vars:
    deploy_name: "production"
    master_cert_hosts:
      - "api.k8s.example.com"
      - "master.k8s.example.com"
  roles:
    - cert-manager
```

### è¯ä¹¦æ›´æ–°

1. æ›´æ–°æ‰€æœ‰è¯ä¹¦ï¼š

```yaml
- hosts: localhost
  vars:
    deploy_name: "production"
    cert_update_mode: "all"
  roles:
    - cert-manager
```

2. ä»…æ›´æ–°ç»„ä»¶è¯ä¹¦ï¼ˆä¿ç•™ CAï¼‰ï¼š

```yaml
- hosts: localhost
  vars:
    deploy_name: "production"
    cert_update_mode: "components_only"
  roles:
    - cert-manager
```

### é«˜çº§é…ç½®

1. è‡ªå®šä¹‰è¯ä¹¦æœ‰æ•ˆæœŸï¼š

```yaml
- hosts: localhost
  vars:
    deploy_name: "production"
    cert_expiry: "17520h"  # 2å¹´æœ‰æ•ˆæœŸ
  roles:
    - cert-manager
```

2. é’ˆå¯¹é«˜å¯ç”¨é›†ç¾¤é…ç½®ï¼š

```yaml
- hosts: localhost
  vars:
    deploy_name: "ha-cluster"
    kube_apiserver_lb_addr: "10.0.0.100"  # è´Ÿè½½å‡è¡¡å™¨ IP
    master_cert_hosts:
      - "api.k8s.example.com"
      - "api-int.k8s.example.com"
  roles:
    - cert-manager
```

### ä½¿ç”¨æ ‡ç­¾æ‰§è¡Œç‰¹å®šä»»åŠ¡

1. ä»…æ‰§è¡Œè¯ä¹¦æ›´æ–°ç›¸å…³ä»»åŠ¡ï¼š

```bash
ansible-playbook -i inventory cert-playbook.yml --tags "update-certs"
```

2. ä»…æ›´æ–°ç‰¹å®šç»„ä»¶çš„è¯ä¹¦ï¼š

```bash
ansible-playbook -i inventory cert-playbook.yml --tags "kubelet"
```

## ğŸ’¡ ä½¿ç”¨å†…ç½®æ–¹æ³•è°ƒç”¨

```bash
ansible-playbook -e @deploy/example/config.yml -i deploy/example/hosts playbooks/01.system-init.yml 
```

### æœ€ä½³å®è·µ

1. **è¯ä¹¦å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½ `{{ generate_certs_dir }}` ç›®å½•ä¸­çš„æ‰€æœ‰è¯ä¹¦å’Œé…ç½®æ–‡ä»¶
2. **è¯ä¹¦è½®æ¢**ï¼šè®¡åˆ’å®šæœŸçš„è¯ä¹¦è½®æ¢ï¼ˆä¾‹å¦‚æ¯å¹´ä¸€æ¬¡ï¼‰
3. **å®‰å…¨å­˜å‚¨**ï¼šç¡®ä¿è¯ä¹¦å’Œé…ç½®æ–‡ä»¶çš„å®‰å…¨å­˜å‚¨ï¼Œç‰¹åˆ«æ˜¯ CA å¯†é’¥
4. **è‡ªåŠ¨åŒ–**ï¼šå°†è¯ä¹¦ç”Ÿæˆå’Œæ›´æ–°æ•´åˆåˆ°æŒç»­é›†æˆ/æŒç»­éƒ¨ç½²ï¼ˆCI/CDï¼‰æµç¨‹ä¸­
5. **æœ‰æ•ˆæœŸç›‘æ§**ï¼šè®¾ç½®ç›‘æ§ä»¥åœ¨è¯ä¹¦æ¥è¿‘è¿‡æœŸæ—¶æé†’

### æ•…éšœæ’é™¤æç¤º

* å¦‚æœé‡åˆ°è¯ä¹¦ç”Ÿæˆé—®é¢˜ï¼Œæ£€æŸ¥ CFSSL å·¥å…·å®‰è£…
* ç¡®ä¿ kubectl ç‰ˆæœ¬ä¸ç›®æ ‡ Kubernetes é›†ç¾¤å…¼å®¹
* è¯ä¹¦æ›´æ–°åï¼Œå¯èƒ½éœ€è¦é‡å¯ç›¸å…³çš„ Kubernetes ç»„ä»¶ä½¿æ–°è¯ä¹¦ç”Ÿæ•ˆ
* ä½¿ç”¨ `openssl x509 -in cert.pem -text -noout` å‘½ä»¤æŸ¥çœ‹è¯ä¹¦è¯¦æƒ…å’Œæœ‰æ•ˆæœŸ

## âš ï¸ æ³¨æ„äº‹é¡¹

* **CA ç§é’¥å®‰å…¨**ï¼šCA ç§é’¥ï¼ˆ`ca-key.pem`ï¼‰æ˜¯æœ€æ•æ„Ÿçš„æ–‡ä»¶ï¼Œåº”ç‰¹åˆ«ä¿æŠ¤
* **è¯ä¹¦å¤‡ä»½**ï¼šç¡®ä¿åœ¨æ›´æ–°è¯ä¹¦å‰æœ‰å¯é çš„å¤‡ä»½
* **ç”Ÿäº§ç¯å¢ƒ**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”ä½¿ç”¨æ›´å¼ºçš„å¯†é’¥é•¿åº¦ï¼ˆè‡³å°‘ 2048 ä½ RSAï¼‰
* **è¯ä¹¦ä¾èµ–**ï¼šæ›´æ”¹ CA è¯ä¹¦ä¼šå¯¼è‡´æ‰€æœ‰å·²ç­¾å‘çš„è¯ä¹¦å¤±æ•ˆ
* **API æœåŠ¡å™¨ä¸»æœºå**ï¼šç¡®ä¿ API æœåŠ¡å™¨è¯ä¹¦ä¸­åŒ…å«æ‰€æœ‰å¯èƒ½ç”¨äºè®¿é—® API çš„ä¸»æœºåå’Œ IP åœ°å€

---

ğŸ” é€šè¿‡ `cert-manager` è§’è‰²ï¼Œæ‚¨å¯ä»¥è½»æ¾ç®¡ç† Kubernetes é›†ç¾¤çš„æ•´ä¸ªè¯ä¹¦ç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿é›†ç¾¤é€šä¿¡å®‰å…¨æ— å¿§ã€‚

## ä½œè€…ä¿¡æ¯

* ä½œè€…ï¼šYan Shicheng
* é‚®ç®±ï¼šyans121@sina.com
* githubï¼šhttps://github.com/yanshicheng
