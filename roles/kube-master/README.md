# Kube-Master è§’è‰²

![Kubernetes](https://img.shields.io/badge/Kubernetes-%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2-blue)![Master](https://img.shields.io/badge/Master-%E9%83%A8%E7%BD%B2-orange)![é«˜å¯ç”¨](https://img.shields.io/badge/%E9%AB%98%E5%8F%AF%E7%94%A8-%E9%9B%86%E7%BE%A4-green)

## ğŸ“‹ ç®€ä»‹

`kube-master` è§’è‰²è´Ÿè´£åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²å’Œé…ç½®æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œæ˜¯æ„å»ºé«˜å¯ç”¨ Kubernetes é›†ç¾¤çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚è¯¥è§’è‰²è‡ªåŠ¨åŒ–äº†æ§åˆ¶å¹³é¢å„ç»„ä»¶ï¼ˆkube-apiserverã€kube-controller-managerã€kube-schedulerï¼‰çš„éƒ¨ç½²æµç¨‹ï¼Œå¹¶é…ç½® kube-proxy ç»„ä»¶å®ç°é›†ç¾¤å†…éƒ¨æœåŠ¡çš„ç½‘ç»œä»£ç†ã€‚

è§’è‰²æ”¯æŒä»¥é™æ€ Podï¼ˆmanifestï¼‰æˆ–ç³»ç»ŸæœåŠ¡ï¼ˆsystemdï¼‰ä¸¤ç§æ¨¡å¼éƒ¨ç½²æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œé€‚åº”ä¸åŒç¯å¢ƒéœ€æ±‚ï¼ŒåŒæ—¶å†…ç½®å®Œå–„çš„è¯ä¹¦åˆ†å‘å’Œå¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œç¡®ä¿æ§åˆ¶å¹³é¢ç»„ä»¶å®‰å…¨å¯é åœ°è¿è¡Œã€‚

## ğŸ¯ é€‚ç”¨åœºæ™¯

* **æ–°å»º Kubernetes é›†ç¾¤**ï¼šå¿«é€Ÿéƒ¨ç½²æ ‡å‡† Kubernetes æ§åˆ¶å¹³é¢
* **é«˜å¯ç”¨æ§åˆ¶å¹³é¢æ„å»º**ï¼šéƒ¨ç½²å¤šèŠ‚ç‚¹æ§åˆ¶å¹³é¢å®ç°é«˜å¯ç”¨æ€§
* **æ§åˆ¶å¹³é¢å‡çº§**ï¼šåœ¨ç°æœ‰é›†ç¾¤ä¸­å‡çº§æ§åˆ¶å¹³é¢ç»„ä»¶ç‰ˆæœ¬
* **ç¾éš¾æ¢å¤**ï¼šåœ¨æ§åˆ¶å¹³é¢æ•…éšœåé‡å»ºé›†ç¾¤
* **è‡ªå®šä¹‰é›†ç¾¤é…ç½®**ï¼šæ ¹æ®ç‰¹å®šéœ€æ±‚è‡ªå®šä¹‰æ§åˆ¶å¹³é¢å‚æ•°
* **æ··åˆäº‘ç¯å¢ƒ**ï¼šåœ¨å„ç§åŸºç¡€è®¾æ–½ä¸Šéƒ¨ç½²æ ‡å‡†åŒ–çš„æ§åˆ¶å¹³é¢
* **ç¦»çº¿ç¯å¢ƒéƒ¨ç½²**ï¼šæ”¯æŒåœ¨æ— äº’è”ç½‘ç¯å¢ƒä¸­éƒ¨ç½²æ§åˆ¶å¹³é¢
* **å¤§è§„æ¨¡é›†ç¾¤**ï¼šèƒ½å¤Ÿåº”å¯¹å¤§å‹é›†ç¾¤çš„æ§åˆ¶å¹³é¢é…ç½®éœ€æ±‚

## âœ¨ åŠŸèƒ½è¯´æ˜

### ğŸ” è¯ä¹¦ä¸æˆæƒç®¡ç†

* **è¯ä¹¦åˆ†å‘**ï¼šå°†é›†ç¾¤ CA å’Œç»„ä»¶è¯ä¹¦åˆ†å‘åˆ°å„èŠ‚ç‚¹
* **kubeconfig é…ç½®**ï¼šä¸ºå„ç»„ä»¶ç”Ÿæˆä¸“ç”¨çš„ kubeconfig æ–‡ä»¶
* **è¯ä¹¦å®Œæ•´æ€§æ£€æŸ¥**ï¼šéªŒè¯æ‰€æœ‰å¿…éœ€çš„è¯ä¹¦å’Œå¯†é’¥æ˜¯å¦å·²ç”Ÿæˆ
* **è§’è‰²ç»‘å®šè®¾ç½®**ï¼šè‡ªåŠ¨åˆ›å»ºå¿…è¦çš„ RBAC æƒé™

### ğŸ—ï¸ æ§åˆ¶å¹³é¢éƒ¨ç½²

* **å¤šæ¨¡å¼éƒ¨ç½²**ï¼šæ”¯æŒé™æ€ Podï¼ˆmanifestï¼‰å’Œç³»ç»ŸæœåŠ¡ï¼ˆsystemdï¼‰éƒ¨ç½²æ¨¡å¼
* **ç»„ä»¶é…ç½®**ï¼šæ ¹æ®é›†ç¾¤è§„æ¨¡å’Œéœ€æ±‚è‡ªåŠ¨é…ç½®æ§åˆ¶å¹³é¢ç»„ä»¶å‚æ•°
* **apiserver é«˜å¯ç”¨**ï¼šé…ç½®æ”¯æŒè™šæ‹Ÿ IP æˆ–è´Ÿè½½å‡è¡¡çš„é«˜å¯ç”¨æ§åˆ¶å¹³é¢
* **etcd é›†æˆ**ï¼šæ”¯æŒä½¿ç”¨å†…éƒ¨æˆ–å¤–éƒ¨ etcd é›†ç¾¤
* **å¥åº·æ£€æŸ¥**ï¼šéƒ¨ç½²åè‡ªåŠ¨éªŒè¯å„ç»„ä»¶çš„å¥åº·çŠ¶æ€

### ğŸŒ ç½‘ç»œé…ç½®

* **kube-proxy éƒ¨ç½²**ï¼šä»¥ DaemonSet æ–¹å¼éƒ¨ç½² kube-proxy
* **IPVS æ¨¡å¼**ï¼šé»˜è®¤é…ç½®é«˜æ€§èƒ½çš„ IPVS ä»£ç†æ¨¡å¼
* **æœåŠ¡ç½‘ç»œ**ï¼šè‡ªåŠ¨é…ç½®é›†ç¾¤æœåŠ¡ç½‘ç»œå’Œ DNS æœåŠ¡

### ğŸ·ï¸ èŠ‚ç‚¹ç®¡ç†

* **èŠ‚ç‚¹æ ‡è®°**ï¼šè‡ªåŠ¨ä¸ºæ§åˆ¶å¹³é¢èŠ‚ç‚¹æ·»åŠ  control-plane å’Œ master æ ‡ç­¾
* **æ±¡ç‚¹è®¾ç½®**ï¼šä¸ºæ§åˆ¶å¹³é¢èŠ‚ç‚¹è®¾ç½® NoSchedule æ±¡ç‚¹ï¼Œé˜²æ­¢å·¥ä½œè´Ÿè½½å¹²æ‰°æ§åˆ¶å¹³é¢
* **å·¥ä½œèŠ‚ç‚¹æ ‡è®°**ï¼šä¸ºéæ§åˆ¶å¹³é¢èŠ‚ç‚¹æ·»åŠ  node å’Œ worker æ ‡ç­¾

## ğŸ“ å˜é‡è¯´æ˜

### åŸºç¡€é…ç½®å˜é‡


| å˜é‡å                   | é»˜è®¤å€¼                      | è¯´æ˜                                                           |
| ------------------------ | --------------------------- | -------------------------------------------------------------- |
| `deploy_name`            | `"example"`                 | éƒ¨ç½²åç§°ï¼Œç”¨äºç»„ç»‡ç”Ÿæˆçš„æ–‡ä»¶                                   |
| `kubernetes_version`     | `"v1.32.3"`                 | Kubernetes ç‰ˆæœ¬                                                |
| `control_deploy_pattern` | `"manifest"`                | æ§åˆ¶å¹³é¢éƒ¨ç½²æ¨¡å¼ï¼š`manifest`ï¼ˆé™æ€Podï¼‰æˆ–`systemd`ï¼ˆç³»ç»ŸæœåŠ¡ï¼‰ |
| `kube_base_dir`          | `"/etc/kubernetes"`         | Kubernetes é…ç½®åŸºç¡€ç›®å½•                                        |
| `base_dir`               | `"/opt/kubernetes"`         | äºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾è·¯å¾„                                             |
| `ca_dir`                 | `"{{ kube_base_dir }}/pki"` | è¯ä¹¦å­˜å‚¨ç›®å½•                                                   |
| `bind_all_address`       | `"0.0.0.0"`                 | ç»„ä»¶ç›‘å¬åœ°å€ï¼ˆ`0.0.0.0`æˆ–`127.0.0.1`ï¼‰                         |

### ç½‘ç»œé…ç½®


| å˜é‡å                   | é»˜è®¤å€¼            | è¯´æ˜                                      |
| ------------------------ | ----------------- | ----------------------------------------- |
| `kube_apiserver_lb_addr` | `"127.0.0.1"`     | API æœåŠ¡å™¨è´Ÿè½½å‡è¡¡å™¨åœ°å€                  |
| `kube_apiserver_lb_port` | `"6443"`          | API æœåŠ¡å™¨è´Ÿè½½å‡è¡¡å™¨ç«¯å£                  |
| `service_cidr`           | `"10.96.0.0/12"`  | æœåŠ¡ç½‘ç»œ CIDR                             |
| `pod_cidr`               | `"10.244.0.0/16"` | Pod ç½‘ç»œ CIDR                             |
| `cluster_dns_domain`     | `"cluster.local"` | é›†ç¾¤ DNS åŸŸå                             |
| `cluster_dns_svc_ip`     | è‡ªåŠ¨è®¡ç®—          | é›†ç¾¤ DNS æœåŠ¡ IPï¼ˆä» service\_cidr è®¡ç®—ï¼‰ |
| `service_nodeport_range` | `"30000-32767"`   | NodePort æœåŠ¡ç«¯å£èŒƒå›´                     |
| `proxy_mode`             | `"ipvs"`          | kube-proxy ä»£ç†æ¨¡å¼                       |

### é•œåƒé…ç½®


| å˜é‡å             | é»˜è®¤å€¼                           | è¯´æ˜             |
| ------------------ | -------------------------------- | ---------------- |
| `registry`         | `"registry.ikubeops.local:5000"` | å®¹å™¨é•œåƒä»“åº“åœ°å€ |
| `registry_project` | `"ikubeops"`                     | é•œåƒä»“åº“é¡¹ç›®å   |

### etcd é…ç½®


| å˜é‡å                    | é»˜è®¤å€¼   | è¯´æ˜                                                          |
| ------------------------- | -------- | ------------------------------------------------------------- |
| `use_external_etcd`       | `false`  | æ˜¯å¦ä½¿ç”¨å¤–éƒ¨ etcd é›†ç¾¤                                        |
| `external_etcd_endpoints` | -        | å¤–éƒ¨ etcd é›†ç¾¤ç«¯ç‚¹ï¼ˆä»…å½“ use\_external\_etcd ä¸º true æ—¶ä½¿ç”¨ï¼‰ |
| `inner_etcd_endpoints`    | è‡ªåŠ¨ç”Ÿæˆ | å†…éƒ¨ etcd é›†ç¾¤ç«¯ç‚¹ï¼ˆåŸºäº etcd ä¸»æœºç»„è‡ªåŠ¨ç”Ÿæˆï¼‰                |

### API æœåŠ¡å™¨é…ç½®


| å˜é‡å                               | é»˜è®¤å€¼                                                                  | è¯´æ˜               |
| ------------------------------------ | ----------------------------------------------------------------------- | ------------------ |
| `apiserver_api_audiences`            | `"api,istio-ca"`                                                        | API æœåŠ¡å™¨å—ä¼—     |
| `apiserver_authorization_mode`       | `"Node,RBAC"`                                                           | æˆæƒæ¨¡å¼           |
| `apiserver_enable_admission_plugins` | `"NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook"` | å¯ç”¨çš„å‡†å…¥æ§åˆ¶æ’ä»¶ |

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

1. åœ¨ Ansible æ¸…å•æ–‡ä»¶ä¸­å®šä¹‰ master å’Œ node ä¸»æœºç»„ï¼š

```ini
[ikube_master]
master-1 ansible_host=192.168.1.101
master-2 ansible_host=192.168.1.102
master-3 ansible_host=192.168.1.103

[ikube_node]
node-1 ansible_host=192.168.1.111
node-2 ansible_host=192.168.1.112
```

2. åœ¨ playbook ä¸­å¼•ç”¨è§’è‰²ï¼š

```yaml
- hosts: ikube_master:ikube_node
  roles:
    - kube-master
```

### é«˜å¯ç”¨æ§åˆ¶å¹³é¢é…ç½®

```yaml
- hosts: ikube_master:ikube_node
  vars:
    kube_apiserver_lb_addr: "192.168.1.100"  # VIP æˆ–è´Ÿè½½å‡è¡¡å™¨åœ°å€
    control_deploy_pattern: "manifest"
    apiserver_authorization_mode: "Node,RBAC,ABAC"
  roles:
    - kube-master
```

### ä½¿ç”¨å¤–éƒ¨ etcd é›†ç¾¤

```yaml
- hosts: ikube_master:ikube_node
  vars:
    use_external_etcd: true
    external_etcd_endpoints: "https://etcd-1.example.com:2379,https://etcd-2.example.com:2379,https://etcd-3.example.com:2379"
  roles:
    - kube-master
```

### è‡ªå®šä¹‰ç½‘ç»œé…ç½®

```yaml
- hosts: ikube_master:ikube_node
  vars:
    service_cidr: "172.16.0.0/16"
    pod_cidr: "172.17.0.0/16"
    cluster_dns_domain: "cluster.mycompany.com"
    proxy_mode: "ipvs"
  roles:
    - kube-master
```

### éƒ¨ç½²æµç¨‹è¯´æ˜

1. **å‰ç½®æ¡ä»¶**ï¼š
   * ç¡®ä¿å·²é€šè¿‡ `cert-manager` è§’è‰²ç”Ÿæˆæ‰€æœ‰å¿…éœ€çš„è¯ä¹¦
   * ç¡®ä¿å·²é€šè¿‡ `kube-node` è§’è‰²åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šéƒ¨ç½² kubelet
   * å¦‚æœä½¿ç”¨å†…éƒ¨ etcdï¼Œç¡®ä¿å·²é€šè¿‡ `etcd` è§’è‰²éƒ¨ç½² etcd é›†ç¾¤
2. **å®Œæ•´éƒ¨ç½²é¡ºåº**ï¼š
   ```bash
   # 1. ç³»ç»Ÿåˆå§‹åŒ–
   ansible-playbook -i inventory.ini system-init.yml

   # 2. å®¹å™¨è¿è¡Œæ—¶å®‰è£…
   ansible-playbook -i inventory.ini container-runtime.yml

   # 3. è¯ä¹¦ç”Ÿæˆ
   ansible-playbook -i inventory.ini cert-manager.yml

   # 4. etcd é›†ç¾¤éƒ¨ç½²ï¼ˆä½¿ç”¨å†…éƒ¨ etcd æ—¶ï¼‰
   ansible-playbook -i inventory.ini etcd.yml

   # 5. æ§åˆ¶å¹³é¢å‰çš„èŠ‚ç‚¹åˆå§‹åŒ–
   ansible-playbook -i inventory.ini kube-node.yml

   # 6. æ§åˆ¶å¹³é¢éƒ¨ç½²
   ansible-playbook -i inventory.ini kube-master.yml

   # 7. ç½‘ç»œæ’ä»¶éƒ¨ç½²
   ansible-playbook -i inventory.ini cni.yml
   ```

### éªŒè¯éƒ¨ç½²

éƒ¨ç½²å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤éªŒè¯æ§åˆ¶å¹³é¢æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

1. æ£€æŸ¥æ§åˆ¶å¹³é¢ Pod çŠ¶æ€ï¼š
   ```bash
   kubectl get pods -n kube-system
   ```
2. éªŒè¯èŠ‚ç‚¹çŠ¶æ€å’Œè§’è‰²ï¼š
   ```bash
   kubectl get nodes -o wide
   ```
3. æ£€æŸ¥å„ç»„ä»¶å¥åº·çŠ¶æ€ï¼š
   ```bash
   kubectl get componentstatuses
   ```
4. æŸ¥çœ‹ kube-proxy çŠ¶æ€ï¼š
   ```bash
   kubectl get daemonset -n kube-system kube-proxy
   ```

### æ³¨æ„äº‹é¡¹

* **è¯ä¹¦ä¾èµ–**ï¼šåœ¨æ‰§è¡Œæ­¤è§’è‰²å‰ï¼Œå¿…é¡»å…ˆé€šè¿‡ `cert-manager` è§’è‰²ç”Ÿæˆæ‰€æœ‰å¿…éœ€çš„è¯ä¹¦
* **éƒ¨ç½²é¡ºåº**ï¼šç¡®ä¿æŒ‰ç…§æ¨èçš„éƒ¨ç½²é¡ºåºæ‰§è¡Œå„ä¸ªè§’è‰²
* **é«˜å¯ç”¨é…ç½®**ï¼šä½¿ç”¨å¤šä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹æ—¶ï¼Œå¿…é¡»é…ç½®è™šæ‹Ÿ IP æˆ–è´Ÿè½½å‡è¡¡å™¨
* **etcd é…ç½®**ï¼šç¡®ä¿ etcd é›†ç¾¤å·²æ­£ç¡®é…ç½®å¹¶å¯è®¿é—®
* **ç½‘ç»œé…ç½®**ï¼šç¡®ä¿ `service_cidr` å’Œ `pod_cidr` ä¸ä¸ç°æœ‰ç½‘ç»œé‡å 
* **èµ„æºéœ€æ±‚**ï¼šæ§åˆ¶å¹³é¢èŠ‚ç‚¹å»ºè®®è‡³å°‘ 2 æ ¸ CPU å’Œ 4GB å†…å­˜
* **é˜²ç«å¢™è§„åˆ™**ï¼šç¡®ä¿æ§åˆ¶å¹³é¢ç»„ä»¶æ‰€éœ€çš„ç«¯å£å·²å¼€æ”¾ï¼ˆå¦‚ 6443, 10250-10252 ç­‰ï¼‰

### æ•…éšœæ’é™¤

å¦‚æœæ§åˆ¶å¹³é¢éƒ¨ç½²å¤±è´¥ï¼Œå¯ä»¥è¿›è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

1. æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦æ­£ç¡®åˆ†å‘ï¼š
   ```bash
   ls -la /etc/kubernetes/pki/
   ```
2. æŸ¥çœ‹é™æ€ Pod çš„æ—¥å¿—ï¼š
   ```bash
   crictl logs <container_id>
   ```
3. æ£€æŸ¥ kubelet æ—¥å¿—ï¼š
   ```bash
   journalctl -u kubelet -f
   ```
4. éªŒè¯ API æœåŠ¡å™¨å¥åº·çŠ¶æ€ï¼š
   ```bash
   curl -k https://127.0.0.1:6443/healthz
   ```

---

ğŸ”„ é€šè¿‡æ­£ç¡®é…ç½®å’Œéƒ¨ç½² kube-master è§’è‰²ï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€å®‰å…¨å¯é çš„ Kubernetes æ§åˆ¶å¹³é¢ï¼Œä¸ºåç»­çš„å·¥ä½œè´Ÿè½½éƒ¨ç½²å¥ å®šåšå®åŸºç¡€ã€‚
