# Kube-Node è§’è‰²

![Kubernetes](https://img.shields.io/badge/Kubernetes-%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86-blue)![Kubelet](https://img.shields.io/badge/Kubelet-%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE-orange)![Node](https://img.shields.io/badge/Node-%E9%83%A8%E7%BD%B2-green)

## ğŸ“‹ ç®€ä»‹

`kube-node` è§’è‰²è´Ÿè´£åœ¨ Kubernetes é›†ç¾¤ä¸­é…ç½®å’Œç®¡ç†å·¥ä½œèŠ‚ç‚¹ã€‚è¯¥è§’è‰²å®ç°äº† kubelet æœåŠ¡çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬è¯ä¹¦åˆ†å‘ã€é…ç½®ç”Ÿæˆã€æœåŠ¡å¯åŠ¨å’ŒçŠ¶æ€éªŒè¯ç­‰ã€‚ä½œä¸º Kubernetes é›†ç¾¤éƒ¨ç½²çš„æ ¸å¿ƒç¯èŠ‚ï¼Œè¯¥è§’è‰²ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹æ­£ç¡®é…ç½®å¹¶èƒ½å¤Ÿå®‰å…¨åœ°åŠ å…¥é›†ç¾¤ï¼Œä¸ºå®¹å™¨åŒ–åº”ç”¨æä¾›ç¨³å®šçš„è¿è¡Œç¯å¢ƒã€‚

è§’è‰²æ‰§è¡Œå‰ä¼šè¿›è¡Œå®Œæ•´çš„å‰ç½®æ£€æŸ¥ï¼Œç¡®ä¿æ‰€æœ‰å¿…è¦æ–‡ä»¶å°±ç»ªï¼Œæ‰§è¡Œå®Œæˆåä¼šéªŒè¯æœåŠ¡çŠ¶æ€ï¼Œç¡®ä¿èŠ‚ç‚¹æ­£å¸¸è¿è¡Œå¹¶èƒ½å¤Ÿæ¥æ”¶è°ƒåº¦çš„å·¥ä½œè´Ÿè½½ã€‚

## ğŸ¯ é€‚ç”¨åœºæ™¯

* **Kubernetes é›†ç¾¤åˆå§‹éƒ¨ç½²**ï¼šåˆå§‹åŒ–é›†ç¾¤å·¥ä½œèŠ‚ç‚¹
* **é›†ç¾¤æ‰©å®¹**ï¼šå‘ç°æœ‰é›†ç¾¤æ·»åŠ æ–°çš„å·¥ä½œèŠ‚ç‚¹
* **èŠ‚ç‚¹ç»„ä»¶å‡çº§**ï¼šå‡çº§ kubelet å’Œç›¸å…³ç»„ä»¶ç‰ˆæœ¬
* **èŠ‚ç‚¹é…ç½®è°ƒä¼˜**ï¼šä¿®æ”¹èŠ‚ç‚¹å‚æ•°ä»¥ä¼˜åŒ–æ€§èƒ½
* **è¯ä¹¦æ›´æ–°**ï¼šå½“èŠ‚ç‚¹è¯ä¹¦éœ€è¦æ›´æ–°æ—¶
* **ç¾éš¾æ¢å¤**ï¼šåœ¨èŠ‚ç‚¹æ•…éšœåæ¢å¤é…ç½®
* **å¤šæ¶æ„éƒ¨ç½²**ï¼šæ”¯æŒ x86\_64ã€ARM64 ç­‰å¤šç§ç¡¬ä»¶æ¶æ„
* **ç¦»çº¿ç¯å¢ƒéƒ¨ç½²**ï¼šé€‚ç”¨äºæ— æ³•è¿æ¥äº’è”ç½‘çš„ç¯å¢ƒ

## âœ¨ åŠŸèƒ½è¯´æ˜

### ğŸ” å‰ç½®æ£€æŸ¥

* **äºŒè¿›åˆ¶æ–‡ä»¶éªŒè¯**ï¼šç¡®ä¿æ§åˆ¶ç«¯çš„ kubelet å’Œ kubectl äºŒè¿›åˆ¶æ–‡ä»¶å­˜åœ¨
* **è¯ä¹¦æ–‡ä»¶æ£€æŸ¥**ï¼šéªŒè¯æ‰€éœ€çš„ CA è¯ä¹¦å’ŒèŠ‚ç‚¹è¯ä¹¦æ˜¯å¦å°±ç»ª
* **kubeconfig æ£€æŸ¥**ï¼šç¡®è®¤èŠ‚ç‚¹ä¸“ç”¨çš„ kubeconfig æ–‡ä»¶å·²ç”Ÿæˆ

### ğŸ“ ç›®å½•ç»“æ„å‡†å¤‡

* **åˆ›å»ºç³»ç»Ÿç›®å½•**ï¼šè‡ªåŠ¨åˆ›å»º kubeletã€kube-proxy ç­‰ç»„ä»¶æ‰€éœ€çš„ç›®å½•
* **CNI ç›®å½•é…ç½®**ï¼šè®¾ç½®å®¹å™¨ç½‘ç»œæ¥å£æ‰€éœ€çš„ç›®å½•
* **è¯ä¹¦å­˜å‚¨**ï¼šå‡†å¤‡å®‰å…¨å­˜å‚¨ TLS è¯ä¹¦çš„ç›®å½•ç»“æ„

### ğŸ” è¯ä¹¦å’Œé…ç½®åˆ†å‘

* **CA è¯ä¹¦åˆ†å‘**ï¼šå°†é›†ç¾¤æ ¹è¯ä¹¦éƒ¨ç½²åˆ°èŠ‚ç‚¹
* **èŠ‚ç‚¹è¯ä¹¦åˆ†å‘**ï¼šå°†èŠ‚ç‚¹ä¸“ç”¨çš„ TLS è¯ä¹¦å’Œå¯†é’¥éƒ¨ç½²åˆ°æŒ‡å®šä½ç½®
* **kubeconfig åˆ†å‘**ï¼šå°†èŠ‚ç‚¹çš„èº«ä»½è®¤è¯é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°åˆé€‚ä½ç½®

### âš™ï¸ æœåŠ¡é…ç½®å’Œç®¡ç†

* **kubelet é…ç½®ç”Ÿæˆ**ï¼šåŸºäºæ¨¡æ¿åˆ›å»º kubelet é…ç½®æ–‡ä»¶
* **systemd æœåŠ¡å•å…ƒ**ï¼šåˆ›å»ºå’Œé…ç½® kubelet çš„ systemd æœåŠ¡
* **æœåŠ¡å¯åŠ¨å’Œç›‘æ§**ï¼šå¯åŠ¨ kubelet æœåŠ¡å¹¶éªŒè¯å…¶è¿è¡ŒçŠ¶æ€
* **å¼€æœºè‡ªå¯åŠ¨**ï¼šç¡®ä¿æœåŠ¡åœ¨ç³»ç»Ÿé‡å¯åè‡ªåŠ¨å¯åŠ¨

### ğŸŒ ç½‘ç»œå’Œ DNS é…ç½®

* **DNS è§£æå™¨é…ç½®**ï¼šè®¾ç½® systemd-resolved ç¡®ä¿æ­£ç¡®çš„ DNS è§£æ
* **ç¯å¢ƒå˜é‡è®¾ç½®**ï¼šé…ç½®å¿…è¦çš„ç³»ç»Ÿç¯å¢ƒå˜é‡
* **å‘½ä»¤è¡Œå·¥å…·å¢å¼º**ï¼šæ·»åŠ  kubectl å‘½ä»¤è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½

## ğŸ“ å˜é‡è¯´æ˜

### åŸºæœ¬é…ç½®å˜é‡


| å˜é‡å              | é»˜è®¤å€¼                      | è¯´æ˜                      |
| ------------------- | --------------------------- | ------------------------- |
| `kube_base_dir`     | `/etc/kubernetes`           | Kubernetes é…ç½®åŸºç¡€ç›®å½•   |
| `kubelet_base_dir`  | `/var/lib/kubelet`          | kubelet ç»„ä»¶å·¥ä½œç›®å½•      |
| `ca_dir`            | `"{{ kube_base_dir }}/pki"` | è¯ä¹¦å­˜å‚¨ç›®å½•              |
| `base_dir`          | `/opt/kubernetes`           | Kubernetes äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½• |
| `container_runtime` | `"containerd"`              | å®¹å™¨è¿è¡Œæ—¶ç±»å‹            |

### API æœåŠ¡å™¨é…ç½®


| å˜é‡å                   | é»˜è®¤å€¼        | è¯´æ˜                   |
| ------------------------ | ------------- | ---------------------- |
| `kube_apiserver_lb_addr` | `"127.0.0.1"` | API æœåŠ¡å™¨è´Ÿè½½å‡è¡¡åœ°å€ |
| `port_apiserver_port`    | `"6443"`      | API æœåŠ¡å™¨ç«¯å£         |

### Kubelet é…ç½®


| å˜é‡å          | é»˜è®¤å€¼      | è¯´æ˜                                     |
| --------------- | ----------- | ---------------------------------------- |
| `max_pods`      | `110`       | èŠ‚ç‚¹æœ€å¤§ Pod æ•°é‡                        |
| `cgroup_driver` | `"systemd"` | cgroup é©±åŠ¨ç±»å‹                          |
| `pod_max_pids`  | `-1`        | å•ä¸ª Pod å…è®¸çš„æœ€å¤§è¿›ç¨‹æ•° (-1è¡¨ç¤ºä¸é™åˆ¶) |

### ç½‘ç»œé…ç½®


| å˜é‡å                   | é»˜è®¤å€¼            | è¯´æ˜                              |
| ------------------------ | ----------------- | --------------------------------- |
| `service_cidr`           | `"10.96.0.0/12"`  | æœåŠ¡ç½‘ç»œ CIDR                     |
| `cluster_dns_domain`     | `"cluster.local"` | é›†ç¾¤ DNS åŸŸååç¼€                 |
| `cluster_dns_svc_ip`     | åŠ¨æ€è®¡ç®—          | é›†ç¾¤ DNS æœåŠ¡ IP (ç½‘æ®µç¬¬10ä¸ªåœ°å€) |
| `enable_local_dns_cache` | `true`            | æ˜¯å¦å¯ç”¨æœ¬åœ° DNS ç¼“å­˜             |
| `local_dns_cache`        | `"169.254.20.10"` | æœ¬åœ° DNS ç¼“å­˜åœ°å€                 |

### èµ„æºé¢„ç•™é…ç½®


| å˜é‡å                  | é»˜è®¤å€¼ | è¯´æ˜                             |
| ----------------------- | ------ | -------------------------------- |
| `kube_reserved_enabled` | `"no"` | æ˜¯å¦å¯ç”¨ Kubernetes ç»„ä»¶èµ„æºé¢„ç•™ |
| `sys_reserved_enabled`  | `"no"` | æ˜¯å¦å¯ç”¨ç³»ç»Ÿèµ„æºé¢„ç•™             |

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

1. åœ¨ ansible æ¸…å•æ–‡ä»¶ä¸­å®šä¹‰èŠ‚ç‚¹ç»„ï¼š

```ini
[ikube_cluster]
node1 ansible_host=192.168.1.101
node2 ansible_host=192.168.1.102
node3 ansible_host=192.168.1.103
```

2. åœ¨ playbook ä¸­å¼•ç”¨è§’è‰²ï¼š

```yaml
- hosts: ikube_cluster
  roles:
    - kube-node
```

### è‡ªå®šä¹‰èŠ‚ç‚¹é…ç½®

```yaml
- hosts: ikube_cluster
  vars:
    max_pods: 150
    cgroup_driver: "systemd"
    kube_reserved_enabled: "yes"
    kubernetes_version: "v1.32.3"
  roles:
    - kube-node
```

### ä½¿ç”¨æ ‡ç­¾è¿›è¡Œç‰¹å®šæ“ä½œ

```bash
# ä»…å‡çº§ kubelet ç»„ä»¶åŠé…ç½®
ansible-playbook -i inventory.ini kube-node.yml --tags "upgrade_k8s,restart_node"

# é‡å¯èŠ‚ç‚¹ä¸Šçš„ kubelet æœåŠ¡
ansible-playbook -i inventory.ini kube-node.yml --tags "restart_node"
```

### èŠ‚ç‚¹æ·»åŠ æµç¨‹

1. é¦–å…ˆç¡®ä¿è¯ä¹¦å·²ç”Ÿæˆï¼š

```bash
ansible-playbook -i inventory.ini cert-manager.yml
```

2. ç„¶åéƒ¨ç½²èŠ‚ç‚¹ç»„ä»¶ï¼š

```bash
ansible-playbook -i inventory.ini kube-node.yml
```

3. éªŒè¯èŠ‚ç‚¹çŠ¶æ€ï¼š

```bash
kubectl get nodes
```

### é«˜çº§é…ç½®ç¤ºä¾‹

1. è°ƒæ•´èŠ‚ç‚¹èµ„æºé¢„ç•™ï¼š

```yaml
vars:
  kube_reserved_enabled: "yes"
  sys_reserved_enabled: "yes"
```

2. é…ç½®æœ¬åœ° DNS ç¼“å­˜ï¼š

```yaml
vars:
  enable_local_dns_cache: true
  local_dns_cache: "169.254.20.10"
```

3. è‡ªå®šä¹‰èŠ‚ç‚¹ç½‘ç»œè®¾ç½®ï¼š

```yaml
vars:
  service_cidr: "10.244.0.0/16"
  cluster_dns_domain: "my-cluster.local"
```

### æ³¨æ„äº‹é¡¹

* ç¡®ä¿åœ¨æ‰§è¡Œè§’è‰²å‰å·²é€šè¿‡ `cert-manager` è§’è‰²ç”ŸæˆèŠ‚ç‚¹è¯ä¹¦
* æ¯ä¸ªèŠ‚ç‚¹çš„ä¸»æœºåéœ€è¦å”¯ä¸€ä¸”ç¬¦åˆ Kubernetes å‘½åè§„èŒƒ
* èŠ‚ç‚¹éœ€è¦æœ‰è¶³å¤Ÿçš„èµ„æºæ¥è¿è¡Œç³»ç»Ÿç»„ä»¶å’Œå·¥ä½œè´Ÿè½½
* èŠ‚ç‚¹é—´ç½‘ç»œéœ€è¦äº’é€šï¼Œç‰¹åˆ«æ˜¯ä¸æ§åˆ¶å¹³é¢çš„è¿æ¥
* å¦‚æœä¿®æ”¹ `service_cidr`ï¼Œç¡®ä¿ä¸æ§åˆ¶å¹³é¢é…ç½®ä¸€è‡´
* å®ŒæˆèŠ‚ç‚¹éƒ¨ç½²åï¼Œå¯èƒ½éœ€è¦é€šè¿‡ `kubectl` æ‰¹å‡† CSR è¯·æ±‚

### æ’éšœæŒ‡å—

å¦‚æœèŠ‚ç‚¹éƒ¨ç½²åæ— æ³•æ­£å¸¸åŠ å…¥é›†ç¾¤ï¼Œè¯·æ£€æŸ¥ï¼š

1. è¯ä¹¦æ˜¯å¦æ­£ç¡®åˆ†å‘ï¼š

```bash
ls -la /etc/kubernetes/pki/
```

2. kubelet æœåŠ¡çŠ¶æ€ï¼š

```bash
systemctl status kubelet
journalctl -u kubelet -n 100
```

3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼š

```bash
ping <kube_apiserver_lb_addr>
telnet <kube_apiserver_lb_addr> <port_apiserver_port>
```

4. API æœåŠ¡å™¨æ˜¯å¦æ¥å—èŠ‚ç‚¹æ³¨å†Œï¼š

```bash
kubectl get csr
```

---

ğŸ”„ æ­¤è§’è‰²æ˜¯ Kubernetes é›†ç¾¤éƒ¨ç½²çš„æ ¸å¿ƒç»„ä»¶ï¼Œç¡®ä¿æŒ‰ç…§æ–‡æ¡£æŒ‡å¯¼æ­£ç¡®é…ç½®ä»¥æ„å»ºç¨³å®šçš„é›†ç¾¤ç¯å¢ƒã€‚
