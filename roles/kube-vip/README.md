# Kube-VIP è§’è‰²

![é«˜å¯ç”¨](https://img.shields.io/badge/%E9%AB%98%E5%8F%AF%E7%94%A8-Kube--VIP-blue)![è´Ÿè½½å‡è¡¡](https://img.shields.io/badge/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-VIP-orange)![Kubernetes](https://img.shields.io/badge/Kubernetes-%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2-green)

## ğŸ“‹ ç®€ä»‹

`kube-vip` è§’è‰²è´Ÿè´£åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²å’Œé…ç½® kube-vip æœåŠ¡ï¼Œä¸ºæ§åˆ¶å¹³é¢æä¾›é«˜å¯ç”¨æ€§è™šæ‹Ÿ IP è§£å†³æ–¹æ¡ˆã€‚kube-vip æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å·¥å…·ï¼Œèƒ½å¤Ÿåœ¨ä¸ä¾èµ–å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„æƒ…å†µä¸‹ï¼Œä¸º Kubernetes API æœåŠ¡å™¨æä¾›è™šæ‹Ÿ IP åœ°å€ï¼Œç¡®ä¿æ§åˆ¶å¹³é¢çš„é«˜å¯ç”¨æ€§å’Œå†—ä½™æ€§ã€‚

è¯¥è§’è‰²æ”¯æŒä¸¤ç§ä¸»è¦çš„ VIP å®ç°æ–¹å¼ï¼šARPï¼ˆé€‚ç”¨äºå•ä¸€äºŒå±‚ç½‘ç»œï¼‰å’Œ BGPï¼ˆé€‚ç”¨äºè·¨ç½‘æ®µç¯å¢ƒï¼‰ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„ç½‘ç»œç¯å¢ƒçµæ´»é€‰æ‹©ã€‚åŒæ—¶ï¼Œå®ƒè¿˜å¯ä»¥ä½œä¸ºé›†ç¾¤å†…éƒ¨çš„æœåŠ¡è´Ÿè½½å‡è¡¡å™¨ï¼Œä¸ºé›†ç¾¤å†…éƒ¨æœåŠ¡æä¾›ç±»ä¼¼äº‘å‚å•†è´Ÿè½½å‡è¡¡å™¨çš„åŠŸèƒ½ã€‚

## ğŸ¯ é€‚ç”¨åœºæ™¯

* **è‡ªå»º Kubernetes é›†ç¾¤çš„é«˜å¯ç”¨æ€§éœ€æ±‚**ï¼šä¸ºæ²¡æœ‰äº‘å‚å•†æä¾›çš„è´Ÿè½½å‡è¡¡å™¨çš„ç¯å¢ƒæä¾›é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆ
* **è¾¹ç¼˜è®¡ç®—ç¯å¢ƒ**ï¼šåœ¨èµ„æºå—é™çš„è¾¹ç¼˜èŠ‚ç‚¹ä¸Šæä¾›è½»é‡çº§é«˜å¯ç”¨æ–¹æ¡ˆ
* **æ•°æ®ä¸­å¿ƒå†…éƒ¨éƒ¨ç½²**ï¼šåœ¨ä¼ä¸šå†…éƒ¨æ•°æ®ä¸­å¿ƒç¯å¢ƒä¸­éƒ¨ç½²é«˜å¯ç”¨ Kubernetes é›†ç¾¤
* **å¤šæ§åˆ¶å¹³é¢èŠ‚ç‚¹æ¶æ„**ï¼šç¡®ä¿å¤šä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹é—´çš„è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨
* **è£¸é‡‘å±æœåŠ¡å™¨éƒ¨ç½²**ï¼šåœ¨æ²¡æœ‰å†…ç½®è´Ÿè½½å‡è¡¡åŠŸèƒ½çš„è£¸é‡‘å±ç¯å¢ƒä¸­éƒ¨ç½²
* **æ··åˆäº‘ç¯å¢ƒ**ï¼šåœ¨æ··åˆäº‘ç¯å¢ƒä¸­ç»Ÿä¸€é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆ
* **å•ä¸€äºŒå±‚ç½‘ç»œç¯å¢ƒ**ï¼šä½¿ç”¨ ARP æ¨¡å¼æä¾›ç®€å•é«˜æ•ˆçš„é«˜å¯ç”¨æ€§
* **è·¨ç½‘æ®µ/è·¨æ•°æ®ä¸­å¿ƒç¯å¢ƒ**ï¼šä½¿ç”¨ BGP æ¨¡å¼åœ¨å¤æ‚ç½‘ç»œæ‹“æ‰‘ä¸­æä¾›é«˜å¯ç”¨æ€§

## âœ¨ åŠŸèƒ½è¯´æ˜

### ğŸ”„ éƒ¨ç½²æ¨¡å¼æ”¯æŒ

* **ARP æ¨¡å¼**ï¼š
  * åŸºäº ARP åè®®å®ç°è™šæ‹Ÿ IP æ¼‚ç§»
  * é€‚ç”¨äºå•ä¸€äºŒå±‚ç½‘ç»œç¯å¢ƒ
  * é…ç½®ç®€å•ï¼Œæ— éœ€é¢å¤–ç½‘ç»œè®¾å¤‡æ”¯æŒ
  * ä½¿ç”¨é€‰ä¸¾æœºåˆ¶ç¡®ä¿åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å“åº” VIP è¯·æ±‚
* **BGP æ¨¡å¼**ï¼š
  * åŸºäºè¾¹ç•Œç½‘å…³åè®®å®ç°è·¯ç”±é€šå‘Š
  * é€‚ç”¨äºè·¨ç½‘æ®µã€è·¨æ•°æ®ä¸­å¿ƒç¯å¢ƒ
  * æ”¯æŒä¸ç°æœ‰ç½‘ç»œåŸºç¡€è®¾æ–½é›†æˆ
  * å¯é…ç½® BGP å¯¹ç­‰ä½“å’Œ AS å·

### âš–ï¸ è´Ÿè½½å‡è¡¡åŠŸèƒ½

* **å†…éƒ¨æœåŠ¡è´Ÿè½½å‡è¡¡**ï¼šä¸ºé›†ç¾¤å†…éƒ¨æœåŠ¡æä¾›è´Ÿè½½å‡è¡¡åŠŸèƒ½
* **å¤šç§è½¬å‘æ–¹æ³•**ï¼šæ”¯æŒæœ¬åœ°ã€éš§é“ã€ä¼ªè£…ã€ç›´æ¥è·¯ç”±å’Œç»•è¿‡ç­‰å¤šç§è½¬å‘æ–¹å¼
* **ä¸ IPVS é›†æˆ**ï¼šåˆ©ç”¨ Linux å†…æ ¸çš„ IPVS æ¨¡å—å®ç°é«˜æ•ˆè½¬å‘

### ğŸ” ç›‘æ§ä¸å¯è§‚æµ‹æ€§

* **Prometheus é›†æˆ**ï¼šæä¾› Prometheus æ ¼å¼çš„ç›‘æ§æŒ‡æ ‡
* **å¥åº·çŠ¶æ€æ£€æŸ¥**ï¼šå®æ—¶ç›‘æ§è™šæ‹Ÿ IP å’ŒæœåŠ¡çš„å¥åº·çŠ¶æ€
* **æ—¥å¿—è¾“å‡º**ï¼šè¯¦ç»†çš„æ“ä½œæ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥

### ğŸ› ï¸ è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸é…ç½®

* **é™æ€ Pod éƒ¨ç½²**ï¼šä½œä¸º Kubernetes é™æ€ Pod éƒ¨ç½²ï¼Œä¸ä¾èµ–äº API æœåŠ¡å™¨
* **é…ç½®æ–‡ä»¶ç”Ÿæˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆæ‰€éœ€çš„é…ç½®æ–‡ä»¶å’Œæ¸…å•
* **å‚æ•°éªŒè¯**ï¼šéƒ¨ç½²å‰éªŒè¯é…ç½®å‚æ•°çš„æœ‰æ•ˆæ€§

## ğŸ“ å˜é‡è¯´æ˜

### åŸºç¡€é…ç½®å˜é‡


| å˜é‡å                   | é»˜è®¤å€¼                            | è¯´æ˜                      |
| ------------------------ | --------------------------------- | ------------------------- |
| `kube_base_dir`          | `/etc/kubernetes`                 | Kubernetes é…ç½®åŸºç¡€ç›®å½•   |
| `base_dir`               | `/opt/kubernetes`                 | Kubernetes äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½• |
| `container_runtime`      | `"containerd"`                    | å®¹å™¨è¿è¡Œæ—¶ç±»å‹            |
| `kube_vip_manifest_path` | `"{{ kube_base_dir }}/manifests"` | kube-vip é…ç½®æ–‡ä»¶å­˜æ”¾è·¯å¾„ |
| `kube_vip_deploy_mode`   | `"arp"`                           | éƒ¨ç½²æ¨¡å¼ï¼š`arp`æˆ–`bgp`    |

### è™šæ‹Ÿ IP é…ç½®


| å˜é‡å                   | é»˜è®¤å€¼        | è¯´æ˜                            |
| ------------------------ | ------------- | ------------------------------- |
| `kube_apiserver_lb_addr` | `"127.0.0.1"` | è™šæ‹Ÿ IP åœ°å€                    |
| `kube_apiserver_lb_port` | `"6443"`      | API æœåŠ¡å™¨ç«¯å£                  |
| `kube_vip_cidr`          | `"32"`        | è™šæ‹Ÿ IP çš„ CIDR å‰ç¼€é•¿åº¦        |
| `kube_vip_subnet`        | `"/32"`       | è™šæ‹Ÿ IP çš„å­ç½‘æ©ç ï¼ˆCIDR æ ¼å¼ï¼‰ |

### é•œåƒé…ç½®


| å˜é‡å             | é»˜è®¤å€¼                           | è¯´æ˜                  |
| ------------------ | -------------------------------- | --------------------- |
| `registry`         | `"registry.ikubeops.local:5000"` | å®¹å™¨é•œåƒä»“åº“åœ°å€      |
| `registry_project` | `"ikubeops"`                     | é•œåƒä»“åº“é¡¹ç›®å        |
| `kube_vip_version` | `"v0.8.9"`                       | kube-vip ç‰ˆæœ¬         |
| `kube_vip_image`   | è‡ªåŠ¨ç”Ÿæˆ                         | kube-vip å®Œæ•´é•œåƒåœ°å€ |

### ARP æ¨¡å¼é…ç½®


| å˜é‡å               | é»˜è®¤å€¼   | è¯´æ˜                   |
| -------------------- | -------- | ---------------------- |
| `kube_vip_interface` | `"eth0"` | ARP æ¨¡å¼ä½¿ç”¨çš„ç½‘ç»œæ¥å£ |

### BGP æ¨¡å¼é…ç½®


| å˜é‡å                     | é»˜è®¤å€¼    | è¯´æ˜                                      |
| -------------------------- | --------- | ----------------------------------------- |
| `kube_vip_bgp_enable`      | `false`   | æ˜¯å¦å¯ç”¨ BGP æ¨¡å¼                         |
| `kube_vip_bgp_interface`   | `"lo"`    | BGP æ¨¡å¼ä½¿ç”¨çš„ç½‘ç»œæ¥å£                    |
| `kube_vip_bgp_routerid`    | `""`      | BGP è·¯ç”±å™¨ IDï¼ˆä¸ºç©ºæ—¶ä½¿ç”¨èŠ‚ç‚¹ IPï¼‰        |
| `kube_vip_bgp_as`          | `"64513"` | æœ¬åœ° AS å·                                |
| `kube_vip_bgp_peeraddress` | `""`      | BGP å¯¹ç­‰ä½“åœ°å€                            |
| `kube_vip_bgp_peerpass`    | `""`      | BGP å¯¹ç­‰ä½“å¯†ç                             |
| `kube_vip_bgp_peeras`      | `"64513"` | BGP å¯¹ç­‰ä½“ AS å·                          |
| `kube_vip_bgp_peers`       | `""`      | BGP å¯¹ç­‰ä½“åˆ—è¡¨ï¼ˆæ ¼å¼ï¼šIP:ASå·:å¯†ç :å¤šè·³ï¼‰ |

### é«˜çº§åŠŸèƒ½é…ç½®


| å˜é‡å                       | é»˜è®¤å€¼    | è¯´æ˜                     |
| ---------------------------- | --------- | ------------------------ |
| `kube_vip_leader_election`   | `true`    | æ˜¯å¦å¯ç”¨é¢†å¯¼è€…é€‰ä¸¾       |
| `kube_vip_enable_lb`         | `true`    | æ˜¯å¦å¯ç”¨è´Ÿè½½å‡è¡¡åŠŸèƒ½     |
| `kube_vip_lb_fwdmethod`      | `"local"` | è´Ÿè½½å‡è¡¡è½¬å‘æ–¹æ³•         |
| `kube_vip_enable_prometheus` | `true`    | æ˜¯å¦å¯ç”¨ Prometheus ç›‘æ§ |
| `kube_vip_prometheus`        | `":2112"` | Prometheus æŒ‡æ ‡æš´éœ²ç«¯å£  |

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

1. åœ¨ playbook ä¸­å¼•ç”¨è§’è‰²:

```yaml
- hosts: kube_masters
  roles:
    - kube-vip
```

2. è‡ªå®šä¹‰è™šæ‹Ÿ IP åœ°å€:

```yaml
- hosts: kube_masters
  vars:
    kube_apiserver_lb_addr: "192.168.1.100"
    kube_apiserver_lb_port: "6443"
  roles:
    - kube-vip
```

### ARP æ¨¡å¼é…ç½®

```yaml
- hosts: kube_masters
  vars:
    kube_vip_deploy_mode: "arp"
    kube_apiserver_lb_addr: "192.168.1.100"
    kube_vip_interface: "ens192"  # æŒ‡å®šæ‚¨çš„ç½‘ç»œæ¥å£
  roles:
    - kube-vip
```

### BGP æ¨¡å¼é…ç½®

```yaml
- hosts: kube_masters
  vars:
    kube_vip_deploy_mode: "bgp"
    kube_apiserver_lb_addr: "192.168.1.100"
    kube_vip_bgp_enable: true
    kube_vip_bgp_as: "65000"
    kube_vip_bgp_peers: "192.168.1.254:65001::false"  # è·¯ç”±å™¨ IP:AS:å¯†ç :å¤šè·³
  roles:
    - kube-vip
```

### é«˜çº§é…ç½®ç¤ºä¾‹

```yaml
- hosts: kube_masters
  vars:
    kube_vip_deploy_mode: "arp"
    kube_apiserver_lb_addr: "192.168.1.100"
    kube_vip_interface: "ens192"
    kube_vip_enable_lb: true
    kube_vip_lb_fwdmethod: "masquerade"
    kube_vip_enable_prometheus: true
    kube_vip_prometheus: ":2112"
  roles:
    - kube-vip
```

### éƒ¨ç½²åéªŒè¯

éƒ¨ç½²å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤éªŒè¯ kube-vip æ˜¯å¦æ­£å¸¸å·¥ä½œ:

1. æ£€æŸ¥ kube-vip Pod æ˜¯å¦æ­£å¸¸è¿è¡Œ:
   ```bash
   kubectl -n kube-system get pod | grep kube-vip
   ```
2. éªŒè¯è™šæ‹Ÿ IP æ˜¯å¦å¯è®¿é—®:
   ```bash
   ping <kube_apiserver_lb_addr>
   ```
3. éªŒè¯ API æœåŠ¡å™¨ç«¯ç‚¹:
   ```bash
   curl -k https://<kube_apiserver_lb_addr>:<kube_apiserver_lb_port>/healthz
   ```
4. å¦‚æœä½¿ç”¨çš„æ˜¯ BGP æ¨¡å¼ï¼Œæ£€æŸ¥è·¯ç”±å™¨ä¸Šæ˜¯å¦æ”¶åˆ°è·¯ç”±é€šå‘Š:
   ```bash
   # åœ¨ç½‘ç»œè®¾å¤‡ä¸Šæ‰§è¡Œ
   show ip bgp neighbors
   show ip route bgp
   ```

### æ³¨æ„äº‹é¡¹

* **ARP æ¨¡å¼**:
  * ç¡®ä¿æ‰€æœ‰æ§åˆ¶å¹³é¢èŠ‚ç‚¹åœ¨åŒä¸€ä¸ªäºŒå±‚ç½‘ç»œä¸­
  * ç¡®ä¿ç½‘ç»œç¯å¢ƒå…è®¸ ARP å¹¿æ’­
  * é¿å…ä¸ç½‘ç»œä¸­å·²æœ‰ IP åœ°å€å†²çª
* **BGP æ¨¡å¼**:
  * éœ€è¦ç½‘ç»œè®¾å¤‡æ”¯æŒ BGP åè®®
  * é…ç½®æ­£ç¡®çš„ AS å·å’Œå¯¹ç­‰ä½“ä¿¡æ¯
  * å¯èƒ½éœ€è¦ç½‘ç»œç®¡ç†å‘˜ååŠ©é…ç½®ç½‘ç»œè®¾å¤‡
* **è´Ÿè½½å‡è¡¡åŠŸèƒ½**:
  * å¯ç”¨è´Ÿè½½å‡è¡¡åŠŸèƒ½æ—¶ï¼Œç¡®ä¿å·²åŠ è½½ IPVS å†…æ ¸æ¨¡å—
  * å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥:
    ```bash
    lsmod | grep ip_vs
    ```
  * å¦‚æœæœªåŠ è½½ï¼Œè¯·åŠ è½½æ‰€éœ€æ¨¡å—:
    ```bash
    modprobe ip_vsmodprobe ip_vs_rrmodprobe ip_vs_wrrmodprobe ip_vs_shmodprobe nf_conntrack
    ```
* **é«˜å¯ç”¨é…ç½®**:
  * å»ºè®®è‡³å°‘éƒ¨ç½² 3 ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä»¥ç¡®ä¿é«˜å¯ç”¨æ€§
  * ç¡®ä¿æ‰€æœ‰æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šçš„ kube-vip é…ç½®ä¸€è‡´

---

ğŸ”„ é€šè¿‡æ­£ç¡®é…ç½®å’Œéƒ¨ç½² kube-vipï¼Œæ‚¨å¯ä»¥ä¸º Kubernetes é›†ç¾¤æä¾›ç¨³å®šå¯é çš„é«˜å¯ç”¨æ€§æ§åˆ¶å¹³é¢ï¼Œæ— éœ€ä¾èµ–å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨æœåŠ¡ã€‚
